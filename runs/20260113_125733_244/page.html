<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8" />
  <title>GE Appliances 9-to-5 Timesheet Review & Evaluation Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    :root {
      --ge-blue: #005CB9;
      --ge-blue-dark: #004a94;
      --ge-gray-dark: #6D6E71;
      --ge-gray-light: #B1B3B3;
      --ge-bg: #ffffff;
      --ge-text: #111827;
    }
    .dark {
      --ge-bg: #111827;
      --ge-text: #ffffff;
    }
    .high-contrast {
      --ge-bg: #000;
      --ge-text: #fff;
      --ge-blue: #00f;
      --ge-gray-dark: #fff;
      --ge-gray-light: #ccc;
    }
    body {
      font-family: 'Nunito Sans', sans-serif;
      background: var(--ge-bg);
      color: var(--ge-text);
    }
    .btn-primary {
      background: var(--ge-blue);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary:hover {
      background: var(--ge-blue-dark);
    }
    .btn-primary:disabled {
      background: var(--ge-gray-light);
      cursor: not-allowed;
    }
    .progress-bar {
      width: 0%;
      height: 4px;
      background: var(--ge-blue);
      transition: width 0.4s ease;
    }
    .error-alert {
      background: #fee;
      color: #c00;
      border-left: 4px solid #c00;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.375rem;
    }
    .dark .error-alert {
      background: #400;
      color: #f88;
    }
    .high-contrast .error-alert {
      background: #000;
      color: #f00;
      border-color: #f00;
    }
    table thead th {
      position: sticky;
      top: 0;
      background: var(--ge-bg);
      z-index: 10;
    }
    .hover-row:hover {
      background: rgba(0, 94, 185, 0.08);
    }
    .dark .hover-row:hover {
      background: rgba(0, 94, 185, 0.2);
    }
    .high-contrast .hover-row:hover {
      background: #003;
    }
    .card-sm {
      border: 1px solid var(--ge-gray-light);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .accordion summary {
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 0;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion summary::after {
      content: 'â–¾';
      margin-left: 0.5rem;
      transition: transform 0.2s;
    }
    .accordion[open] summary::after {
      transform: rotate(180deg);
    }
    @media (max-width: 480px) {
      .kpi-card {
        width: 100%;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="w-full border-b border-gray-300">
    <nav class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold" id="appTitle">GE Timesheet Review</h1>
      <ul class="flex gap-4">
        <li><button id="navDashboard" class="btn-primary" aria-label="Dashboard" data-es="Panel">Dashboard</button></li>
        <li><button id="navDetails" class="btn-primary" aria-label="Details" data-es="Detalles">Details</button></li>
        <li><button id="navReports" class="btn-primary" aria-label="Reports" data-es="Informes">Reports</button></li>
      </ul>
    </nav>
  </header>

  <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6">
    <!-- Landing / Raw Data -->
    <section id="landingSection">
      <div class="text-center py-8">
        <button id="uploadBtn" class="btn-primary text-lg" aria-label="Upload Timesheet" data-es="Cargar Hoja de Tiempo">
          Upload Timesheet
        </button>
        <input type="file" id="fileInput" accept=".csv" class="hidden" />
        <div role="status" aria-live="polite" id="statusRegion" class="sr-only"></div>
        <div class="w-full max-w-xl mx-auto mt-4 h-1 bg-gray-200 rounded overflow-hidden">
          <div id="progressBar" class="progress-bar" aria-hidden="true"></div>
        </div>
        <div id="errorContainer" class="hidden mt-4 text-left"></div>
      </div>

      <div id="rawTableWrapper" class="hidden mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3 gap-2">
          <h2 class="text-lg font-semibold">Raw Data Preview</h2>
          <div class="flex gap-2">
            <input id="globalSearch" type="search" placeholder="Search..." class="px-2 py-1 border border-gray-400 rounded" aria-label="Search" data-es="Buscar" />
            <select id="pageSizeSelect" class="px-2 py-1 border border-gray-400 rounded" aria-label="Rows per page" data-es="Filas por pÃ¡gina">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="rawTable" class="w-full text-sm"></table>
        </div>
        <div id="paginationControls" class="flex justify-between items-center mt-2 text-sm"></div>
        <div class="mt-4 flex items-center gap-3">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="reviewedCheckbox" class="mr-1" aria-label="I have reviewed the data" data-es="He revisado los datos" />
            <span id="reviewedLabel">I have reviewed the data</span>
          </label>
          <button id="analyseBtn" class="btn-primary" disabled aria-label="Analyse" data-es="Analizar">Analyse</button>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboardSection" class="hidden">
      <div id="kpiCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card-sm">
          <h3 class="font-semibold mb-2">Employee Hours Ranking</h3>
          <canvas id="hoursChart" aria-label="Employee hours ranking chart"></canvas>
        </div>
        <div class="card-sm">
          <h3 class="font-semibold mb-2">Daily Workforce Totals</h3>
          <canvas id="dailyChart" aria-label="Daily workforce totals chart"></canvas>
        </div>
      </div>
      <div class="card-sm">
        <h3 class="font-semibold mb-2">Aggregated Employee Stats</h3>
        <div class="overflow-x-auto">
          <table id="aggTable" class="w-full text-sm"></table>
        </div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reportsSection" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Printable Reports</h2>
        <button id="printAllBtn" class="btn-primary" aria-label="Print all" data-es="Imprimir todo">Print All</button>
      </div>
      <div id="reportCards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-300 py-4">
    <div class="max-w-7xl mx-auto px-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-3">
        <button id="themeToggle" class="btn-primary text-sm" aria-label="Toggle theme" data-es="Cambiar tema">ðŸŒ— Theme</button>
        <button id="langToggle" class="btn-primary text-sm" aria-label="Cambiar idioma" data-es="Switch language">ES/EN</button>
        <button id="helpToggle" class="btn-primary text-sm" aria-label="Help" data-es="Ayuda">Help</button>
      </div>
      <p class="text-sm text-gray-600">GE Appliances Â© 2026</p>
    </div>
  </footer>

  <!-- Off-canvas Help -->
  <aside id="helpPanel" class="fixed right-0 top-0 h-full w-72 bg-white shadow-2xl transform translate-x-full transition-transform p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold">Keyboard Shortcuts</h3>
      <button id="closeHelp" class="text-gray-600" aria-label="Close help">âœ•</button>
    </div>
    <ul class="text-sm list-disc pl-5 space-y-1">
      <li><kbd>U</kbd> â€“ Upload CSV</li>
      <li><kbd>R</kbd> â€“ Reports</li>
      <li><kbd>/</kbd> â€“ Focus search</li>
    </ul>
  </aside>

  <script>
    (() => {
      const REQUIRED_COLS = ['employee_id', 'name', 'date', 'clock_in', 'clock_out'];
      const FIXED_SCHED = { in: '09:00', out: '17:00', lunch: 60 }; // 9-to-5 with 1h lunch
      const GE_BLUE = '#005CB9';
      const GE_GRAY = '#6D6E71';
      const GE_LIGHT = '#B1B3B3';

      let rawRows = [];
      let filteredRows = [];
      let csvData = [];
      let employees = [];
      let kpis = {};
      let errors = [];
      let pageSize = 25;
      let currentPage = 1;
      let searchTerm = '';
      let filters = {};
      let reviewed = false;
      let theme = 'light';
      let lang = 'en';
      let hoursChart, dailyChart;

      const $ = id => document.getElementById(id);
      const t = (en, es) => lang === 'es' ? es : en;
      const aria = (el, en, es) => el.setAttribute('aria-label', t(en, es));

      const uploadBtn = $('uploadBtn');
      const fileInput = $('fileInput');
      const progressBar = $('progressBar');
      const statusRegion = $('statusRegion');
      const errorContainer = $('errorContainer');
      const rawTableWrapper = $('rawTableWrapper');
      const rawTable = $('rawTable');
      const globalSearch = $('globalSearch');
      const pageSizeSelect = $('pageSizeSelect');
      const paginationControls = $('paginationControls');
      const reviewedCheckbox = $('reviewedCheckbox');
      const reviewedLabel = $('reviewedLabel');
      const analyseBtn = $('analyseBtn');
      const landingSection = $('landingSection');
      const dashboardSection = $('dashboardSection');
      const reportsSection = $('reportsSection');
      const navDashboard = $('navDashboard');
      const navDetails = $('navDetails');
      const navReports = $('navReports');
      const kpiCards = $('kpiCards');
      const aggTable = $('aggTable');
      const reportCards = $('reportCards');
      const themeToggle = $('themeToggle');
      const langToggle = $('langToggle');
      const helpToggle = $('helpToggle');
      const helpPanel = $('helpPanel');
      const closeHelp = $('closeHelp');

      function setTheme(t) {
        theme = t;
        document.documentElement.classList.remove('dark', 'high-contrast');
        if (t === 'dark') document.documentElement.classList.add('dark');
        if (t === 'high-contrast') document.documentElement.classList.add('high-contrast');
      }
      setTheme(theme);

      function updateLang() {
        document.querySelectorAll('[data-es]').forEach(el => {
          const es = el.getAttribute('data-es');
          const en = el.getAttribute('aria-label');
          el.setAttribute('aria-label', lang === 'es' ? es : en);
        });
        reviewedLabel.textContent = t('I have reviewed the data', 'He revisado los datos');
        globalSearch.placeholder = t('Search...', 'Buscar...');
        pageSizeSelect.options[3].textContent = t('All', 'Todo');
        $('appTitle').textContent = t('GE Timesheet Review', 'RevisiÃ³n de Hojas de Tiempo GE');
      }
      updateLang();

      function showSection(section) {
        [landingSection, dashboardSection, reportsSection].forEach(s => s.classList.add('hidden'));
        section.classList.remove('hidden');
      }

      uploadBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFile);

      function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        statusRegion.textContent = t('Uploading...', 'Cargando...');
        progressBar.style.width = '0%';
        errorContainer.classList.add('hidden');
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          step: (results, parser) => {
            const pct = Math.min(100, Math.round((results.meta.cursor / file.size) * 100));
            progressBar.style.width = pct + '%';
          },
          complete: (results) => {
            progressBar.style.width = '100%';
            setTimeout(() => {
              progressBar.style.width = '0%';
              processCSV(results.data);
            }, 300);
          }
        });
      }

      function processCSV(data) {
        errors = [];
        csvData = [];
        rawRows = [];
        const seen = new Set();
        data.forEach((row, idx) => {
          const missing = REQUIRED_COLS.filter(c => !row[c] || !row[c].toString().trim());
          if (missing.length) {
            errors.push({ row: idx + 2, msg: `Missing columns: ${missing.join(', ')}` });
            return;
          }
          const key = `${row.employee_id}|${row.date}`;
          if (seen.has(key)) {
            errors.push({ row: idx + 2, msg: `Duplicate entry for ${row.employee_id} on ${row.date}` });
            return;
          }
          seen.add(key);
          rawRows.push(row);
        });
        if (errors.length) {
          showErrors();
          statusRegion.textContent = t('CSV validation failed', 'ValidaciÃ³n CSV fallÃ³');
          return;
        }
        csvData = rawRows.map(r => ({
          ...r,
          date: dayjs(r.date).format('YYYY-MM-DD'),
          clock_in: r.clock_in.trim(),
          clock_out: r.clock_out.trim()
        }));
        filteredRows = [...csvData];
        renderRawTable();
        rawTableWrapper.classList.remove('hidden');
        statusRegion.textContent = t('CSV loaded. Review data before analysis.', 'CSV cargado. Revise antes de analizar.');
      }

      function showErrors() {
        errorContainer.innerHTML = `
          <div class="error-alert">
            <p class="font-semibold">${t('Validation Errors', 'Errores de ValidaciÃ³n')}</p>
            <ul class="list-disc pl-5 mt-2">${errors.map(e => `<li>Row ${e.row}: ${e.msg}</li>`).join('')}</ul>
            <button id="downloadErrors" class="mt-2 underline text-blue-700 cursor-pointer">${t('Download error log', 'Descargar log de errores')}</button>
          </div>
        `;
        errorContainer.classList.remove('hidden');
        $('downloadErrors').addEventListener('click', () => {
          const blob = new Blob([errors.map(e => `Row ${e.row}: ${e.msg}`).join('\n')], { type: 'text/plain' });
          saveAs(blob, 'errors.log');
        });
      }

      function renderRawTable() {
        const headers = REQUIRED_COLS;
        const start = pageSize === 'all' ? 0 : (currentPage - 1) * pageSize;
        const end = pageSize === 'all' ? filteredRows.length : start + pageSize;
        const page = filteredRows.slice(start, end);

        rawTable.innerHTML = `
          <thead>
            <tr>${headers.map(h => `<th class="p-2 text-left font-semibold border-b">${h}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${page.map(r => `<tr class="hover-row">${headers.map(h => `<td class="p-2 border-b">${r[h] || ''}</td>`).join('')}</tr>`).join('')}
          </tbody>
        `;
        renderPagination();
      }

      function renderPagination() {
        const total = filteredRows.length;
        if (pageSize === 'all') {
          paginationControls.innerHTML = `<span>${total} rows</span>`;
          return;
        }
        const pages = Math.ceil(total / pageSize);
        paginationControls.innerHTML = `
          <button ${currentPage === 1 ? 'disabled' : ''} class="btn-primary text-sm" data-action="prev">${t('Prev', 'Ant')}</button>
          <span>${t('Page', 'PÃ¡gina')} ${currentPage} ${t('of', 'de')} ${pages}</span>
          <button ${currentPage >= pages ? 'disabled' : ''} class="btn-primary text-sm" data-action="next">${t('Next', 'Sig')}</button>
        `;
        paginationControls.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', e => {
            e.preventDefault();
            if (btn.dataset.action === 'prev' && currentPage > 1) currentPage--;
            if (btn.dataset.action === 'next' && currentPage < pages) currentPage++;
            renderRawTable();
          });
        });
      }

      globalSearch.addEventListener('input', e => {
        searchTerm = e.target.value.toLowerCase();
        filterTable();
      });

      pageSizeSelect.addEventListener('change', e => {
        pageSize = e.target.value === 'all' ? 'all' : Number(e.target.value);
        currentPage = 1;
        renderRawTable();
      });

      function filterTable() {
        filteredRows = csvData.filter(r => {
          const matchSearch = searchTerm === '' || REQUIRED_COLS.some(c => r[c]?.toString().toLowerCase().includes(searchTerm));
          return matchSearch;
        });
        currentPage = 1;
        renderRawTable();
      }

      reviewedCheckbox.addEventListener('change', e => {
        reviewed = e.target.checked;
        analyseBtn.disabled = !reviewed;
      });

      analyseBtn.addEventListener('click', runAnalytics);

      function runAnalytics() {
        const empMap = {};
        csvData.forEach(r => {
          const id = r.employee_id;
          if (!empMap[id]) {
            empMap[id] = { id, name: r.name, days: new Set(), hours: 0, late: 0, overtime: 0 };
          }
          const inTime = dayjs(`${r.date} ${r.clock_in}`);
          const outTime = dayjs(`${r.date} ${r.clock_out}`);
          const mins = outTime.diff(inTime, 'minute') - FIXED_SCHED.lunch;
          const hrs = mins / 60;
          empMap[id].hours += hrs;
          empMap[id].days.add(r.date);
          const scheduledIn = dayjs(`${r.date} ${FIXED_SCHED.in}`);
          const lateMins = inTime.diff(scheduledIn, 'minute');
          if (lateMins > 5) empMap[id].late += 1;
          if (hrs > 8) empMap[id].overtime += 1;
        });
        employees = Object.values(empMap).map(e => ({
          ...e,
          daysWorked: e.days.size,
          avgDaily: e.hours / e.days.size,
          punctuality: Math.round(((e.days.size - e.late) / e.days.size) * 100)
        }));
        kpis = {
          totalHours: employees.reduce((a, b) => a + b.hours, 0),
          avgHours: employees.reduce((a, b) => a + b.hours, 0) / employees.length,
          totalOvertime: employees.reduce((a, b) => a + b.overtime, 0),
          workforce: employees.length
        };
        showSection(dashboardSection);
        renderKPIs();
        renderAggTable();
        renderCharts();
      }

      function renderKPIs() {
        kpiCards.innerHTML = `
          <div class="card-sm kpi-card">
            <div class="text-sm text-gray-600">${t('Workforce', 'Personal')}</div>
            <div class="text-2xl font-bold">${kpis.workforce}</div>
          </div>
          <div class="card-sm kpi-card">
            <div class="text-sm text-gray-600">${t('Total Hours', 'Horas Totales')}</div>
            <div class="text-2xl font-bold">${kpis.totalHours.toFixed(1)}</div>
          </div>
          <div class="card-sm kpi-card">
            <div class="text-sm text-gray-600">${t('Avg Hours/Employee', 'Promedio Horas/Empleado')}</div>
            <div class="text-2xl font-bold">${kpis.avgHours.toFixed(1)}</div>
          </div>
          <div class="card-sm kpi-card">
            <div class="text-sm text-gray-600">${t('Overtime Days', 'DÃ­as de Extras')}</div>
            <div class="text-2xl font-bold">${kpis.totalOvertime}</div>
          </div>
        `;
      }

      function renderAggTable() {
        const headers = ['Name', 'Days Worked', 'Total Hours', 'Avg Daily', 'Punctuality %', 'Overtime Days'];
        aggTable.innerHTML = `
          <thead>
            <tr>${headers.map(h => `<th class="p-2 text-left font-semibold border-b">${h}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${employees.map(e => `
              <tr class="hover-row">
                <td class="p-2 border-b">${e.name}</td>
                <td class="p-2 border-b">${e.daysWorked}</td>
                <td class="p-2 border-b">${e.hours.toFixed(1)}</td>
                <td class="p-2 border-b">${e.avgDaily.toFixed(1)}</td>
                <td class="p-2 border-b">${e.punctuality}</td>
                <td class="p-2 border-b">${e.overtime}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
      }

      function renderCharts() {
        const ctx1 = $('hoursChart').getContext('2d');
        if (hoursChart) hoursChart.destroy();
        hoursChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: employees.sort((a, b) => b.hours - a.hours).slice(0, 8).map(e => e.name),
            datasets: [{
              label: t('Total Hours', 'Horas Totales'),
              data: employees.sort((a, b) => b.hours - a.hours).slice(0, 8).map(e => e.hours),
              backgroundColor: pattern.draw('diagonal', GE_BLUE),
              borderColor: GE_BLUE,
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: false }
            },
            scales: {
              x: { beginAtZero: true }
            }
          }
        });

        const dailyMap = {};
        csvData.forEach(r => {
          const date = r.date;
          if (!dailyMap[date]) dailyMap[date] = 0;
          const mins = dayjs(`${r.date} ${r.clock_out}`).diff(dayjs(`${r.date} ${r.clock_in}`), 'minute') - FIXED_SCHED.lunch;
          dailyMap[date] += mins / 60;
        });
        const dates = Object.keys(dailyMap).sort();
        const ctx2 = $('dailyChart').getContext('2d');
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: t('Total Hours', 'Horas Totales'),
              data: dates.map(d => dailyMap[d]),
              backgroundColor: pattern.draw('diagonal', GE_GRAY),
              borderColor: GE_GRAY,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      navDashboard.addEventListener('click', () => showSection(dashboardSection));
      navDetails.addEventListener('click', () => showSection(landingSection));
      navReports.addEventListener('click', () => {
        showSection(reportsSection);
        renderReports();
      });

      function renderReports() {
        reportCards.innerHTML = employees.map(e => `
          <div class="card-sm">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">${e.name}</h4>
              <button class="btn-primary text-sm" onclick="printEmployee('${e.id}')">${t('Print PDF', 'Imprimir PDF')}</button>
            </div>
            <div class="text-sm mt-2">
              <p>${t('Total Hours:', 'Horas Totales:')} ${e.hours.toFixed(1)}</p>
              <p>${t('Punctuality:', 'Puntualidad:')} ${e.punctuality}%</p>
              <p>${t('Overtime Days:', 'DÃ­as de Extras:')} ${e.overtime}</p>
            </div>
          </div>
        `).join('');
      }

      window.printEmployee = (id) => {
        const emp = employees.find(e => e.id === id);
        const doc = new jspdf.jsPDF();
        doc.setFontSize(12);
        doc.text(`Employee Evaluation: ${emp.name}`, 10, 10);
        doc.text(`Total Hours: ${emp.hours.toFixed(1)}`, 10, 20);
        doc.text(`Punctuality Score: ${emp.punctuality}%`, 10, 30);
        doc.text(`Overtime Days: ${emp.overtime}`, 10, 40);
        doc.save(`evaluation_${emp.id}.pdf`);
      };

      $('printAllBtn').addEventListener('click', () => {
        const doc = new jspdf.jsPDF();
        doc.setFontSize(12);
        let y = 10;
        employees.forEach(e => {
          doc.text(`${e.name} | Hours: ${e.hours.toFixed(1)} | Punctuality: ${e.punctuality}% | OT: ${e.overtime}`, 10, y);
          y += 10;
        });
        doc.save('all_evaluations.pdf');
      });

      themeToggle.addEventListener('click', () => {
        const themes = ['light', 'dark', 'high-contrast'];
        const idx = themes.indexOf(theme);
        setTheme(themes[(idx + 1) % themes.length]);
      });

      langToggle.addEventListener('click', () => {
        lang = lang === 'en' ? 'es' : 'en';
        updateLang();
      });

      helpToggle.addEventListener('click', () => helpPanel.classList.toggle('translate-x-full'));
      closeHelp.addEventListener('click', () => helpPanel.classList.add('translate-x-full'));

      document.addEventListener('keydown', e => {
        if (e.key === 'u' || e.key === 'U') uploadBtn.click();
        if (e.key === 'r' || e.key === 'R') navReports.click();
        if (e.key === '/') {
          e.preventDefault();
          globalSearch.focus();
        }
      });
    })();
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "moonshotai/kimi-k2-instruct";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>