```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data:; style-src 'unsafe-inline'; script-src 'unsafe-inline'; connect-src 'self' http://localhost:* http://127.0.0.1:*; base-uri 'none'; form-action 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Story Generator</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --danger: #e63946;
            --warning: #fca311;
            --gray: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .form-section {
            padding: 2rem;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .character-counter {
            text-align: right;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a56d4;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .generate-btn {
            flex: 1;
            background-color: var(--success);
            color: white;
        }

        .generate-btn:hover {
            background-color: #3ab0d9;
        }

        .generate-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .story-section {
            padding: 2rem;
        }

        .story-display {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            min-height: 200px;
            border: 1px solid #eee;
            white-space: pre-wrap;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .story-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .error-message {
            color: var(--danger);
            background-color: #ffebee;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            display: none;
        }

        .sample-prompts {
            background-color: #e3f2fd;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        .sample-prompts h3 {
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .prompt-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .prompt-suggestion {
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .prompt-suggestion:hover {
            background-color: var(--primary);
            color: white;
        }

        .history-section {
            padding: 2rem;
            border-top: 1px solid #eee;
        }

        .history-item {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .history-item h4 {
            margin-bottom: 0.5rem;
        }

        .history-item p {
            font-size: 0.9rem;
            color: var(--gray);
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 0;
            }
            
            .form-section, .story-section, .history-section {
                padding: 1rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Enhanced Story Generator</h1>
            <p>Create personalized stories with detailed character, time, and setting information</p>
        </header>
        
        <section class="form-section">
            <div class="form-group">
                <label for="characterName">Main Character Name</label>
                <input type="text" id="characterName" maxlength="100" placeholder="Enter character name">
                <div class="character-counter">0/100</div>
            </div>
            
            <div class="form-group">
                <label for="timePeriod">Time Period</label>
                <select id="timePeriod">
                    <option value="">Select a time period</option>
                    <option value="medieval">Medieval Era</option>
                    <option value="victorian">Victorian Era</option>
                    <option value="future">Future (2050s)</option>
                    <option value="ancient">Ancient Times</option>
                    <option value="modern">Modern Day</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="locationSetting">Location Setting</label>
                <input type="text" id="locationSetting" maxlength="200" placeholder="Where does the story take place?">
                <div class="character-counter">0/200</div>
            </div>
            
            <div class="form-group">
                <label for="userPrompt">Story Prompt</label>
                <textarea id="userPrompt" rows="4" maxlength="500" placeholder="Describe what you'd like to happen in the story..."></textarea>
                <div class="character-counter">0/500</div>
            </div>
            
            <div class="btn-group">
                <button id="generateBtn" class="btn generate-btn">Generate Story</button>
                <button id="samplePromptsBtn" class="btn btn-secondary">Show Sample Prompts</button>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Generating your story...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="sample-prompts" id="samplePrompts">
                <h3>Sample Prompts</h3>
                <div class="prompt-suggestions">
                    <div class="prompt-suggestion">A brave knight must save a kingdom from an evil sorcerer</div>
                    <div class="prompt-suggestion">A detective solves a mystery in a bustling city</div>
                    <div class="prompt-suggestion">A young explorer discovers a hidden island</div>
                    <div class="prompt-suggestion">A time traveler prevents a historical disaster</div>
                </div>
            </div>
        </section>
        
        <section class="story-section">
            <div class="story-display" id="storyDisplay">
                Your generated story will appear here...
            </div>
            
            <div class="story-controls">
                <button id="regenerateBtn" class="btn btn-secondary">Regenerate Story</button>
                <button id="saveBtn" class="btn btn-secondary">Save to History</button>
                <button id="shareBtn" class="btn btn-secondary">Share Story</button>
            </div>
        </section>
        
        <section class="history-section">
            <h2>Story History</h2>
            <div id="historyContainer"></div>
        </section>
    </div>

    <script>
        // State management
        const state = {
            characterName: '',
            timePeriod: '',
            locationSetting: '',
            userPrompt: '',
            isGenerating: false,
            generatedStory: '',
            error: null,
            storyHistory: [],
            showSamplePrompts: false,
            promptLength: 0,
            maxPromptLength: 500,
            formValid: false
        };

        // DOM Elements
        const elements = {
            characterName: document.getElementById('characterName'),
            timePeriod: document.getElementById('timePeriod'),
            locationSetting: document.getElementById('locationSetting'),
            userPrompt: document.getElementById('userPrompt'),
            generateBtn: document.getElementById('generateBtn'),
            samplePromptsBtn: document.getElementById('samplePromptsBtn'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            errorMessage: document.getElementById('errorMessage'),
            storyDisplay: document.getElementById('storyDisplay'),
            regenerateBtn: document.getElementById('regenerateBtn'),
            saveBtn: document.getElementById('saveBtn'),
            shareBtn: document.getElementById('shareBtn'),
            samplePrompts: document.getElementById('samplePrompts'),
            historyContainer: document.getElementById('historyContainer'),
            characterCounters: {
                characterName: document.querySelector('#characterName + .character-counter'),
                locationSetting: document.querySelector('#locationSetting + .character-counter'),
                userPrompt: document.querySelector('#userPrompt + .character-counter')
            }
        };

        // Initialize event listeners
        function initEventListeners() {
            // Input fields
            elements.characterName.addEventListener('input', handleInputChange);
            elements.timePeriod.addEventListener('change', handleInputChange);
            elements.locationSetting.addEventListener('input', handleInputChange);
            elements.userPrompt.addEventListener('input', handleInputChange);
            
            // Buttons
            elements.generateBtn.addEventListener('click', generateStory);
            elements.samplePromptsBtn.addEventListener('click', toggleSamplePrompts);
            elements.regenerateBtn.addEventListener('click', regenerateStory);
            elements.saveBtn.addEventListener('click', saveStory);
            elements.shareBtn.addEventListener('click', shareStory);
            
            // Sample prompt suggestions
            document.querySelectorAll('.prompt-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    elements.userPrompt.value = this.textContent;
                    elements.userPrompt.dispatchEvent(new Event('input'));
                });
            });
        }

        // Handle input changes
        function handleInputChange() {
            state.characterName = elements.characterName.value;
            state.timePeriod = elements.timePeriod.value;
            state.locationSetting = elements.locationSetting.value;
            state.userPrompt = elements.userPrompt.value;
            state.promptLength = state.userPrompt.length;
            
            // Update character counters
            elements.characterCounters.characterName.textContent = `${state.characterName.length}/100`;
            elements.characterCounters.locationSetting.textContent = `${state.locationSetting.length}/200`;
            elements.characterCounters.userPrompt.textContent = `${state.promptLength}/500`;
            
            // Validate form
            validateForm();
        }

        // Validate form
        function validateForm() {
            const isValid = state.characterName.trim() !== '' && 
                           state.timePeriod !== '' && 
                           state.locationSetting.trim() !== '' && 
                           state.userPrompt.trim() !== '';
            
            state.formValid = isValid;
            elements.generateBtn.disabled = !isValid;
            
            if (isValid) {
                elements.errorMessage.style.display = 'none';
            }
        }

        // Toggle sample prompts
        function toggleSamplePrompts() {
            state.showSamplePrompts = !state.showSamplePrompts;
            elements.samplePrompts.style.display = state.showSamplePrompts ? 'block' : 'none';
            elements.samplePromptsBtn.textContent = state.showSamplePrompts ? 'Hide Sample Prompts' : 'Show Sample Prompts';
        }

        // Show error message
        function showError(message) {
            state.error = message;
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
        }

        // Clear error message
        function clearError() {
            state.error = null;
            elements.errorMessage.style.display = 'none';
        }

        // Show loading state
        function showLoading() {
            state.isGenerating = true;
            elements.generateBtn.disabled = true;
            elements.loadingSpinner.style.display = 'block';
        }

        // Hide loading state
        function hideLoading() {
            state.isGenerating = false;
            elements.generateBtn.disabled = !state.formValid;
            elements.loadingSpinner.style.display = 'none';
        }

        // Generate story
        async function generateStory() {
            if (!state.formValid) {
                showError('Please fill in all required fields');
                return;
            }
            
            showLoading();
            clearError();
            
            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Call runtime LLM
                const prompt = `Create a story about ${state.characterName} in ${state.locationSetting} during the ${state.timePeriod} era. The story should be ${state.userPrompt}. Make it engaging and well-structured with proper paragraph breaks.`;
                const story = await window.geaRuntimeLLM(prompt);
                
                state.generatedStory = story;
                elements.storyDisplay.textContent = story;
                hideLoading();
            } catch (error) {
                console.error('Story generation error:', error);
                showError('Failed to generate story. Please try again.');
                hideLoading();
            }
        }

        // Regenerate story
        function regenerateStory() {
            if (state.generatedStory && state.characterName && state.timePeriod && state.locationSetting && state.userPrompt) {
                generateStory();
            } else {
                showError('No story to regenerate. Please generate a story first.');
            }
        }

        // Save story to history
        function saveStory() {
            if (!state.generatedStory) {
                showError('No story to save. Please generate a story first.');
                return;
            }
            
            const historyItem = {
                characterName: state.characterName,
                timePeriod: state.timePeriod,
                locationSetting: state.locationSetting,
                prompt: state.userPrompt,
                story: state.generatedStory,
                timestamp: new Date().toISOString()
            };
            
            state.storyHistory.unshift(historyItem);
            renderHistory();
        }

        // Share story
        function shareStory() {
            if (!state.generatedStory) {
                showError('No story to share. Please generate a story first.');
                return;
            }
            
            navigator.clipboard.writeText(state.generatedStory)
                .then(() => {
                    alert('Story copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showError('Failed to copy story to clipboard');
                });
        }

        // Render history
        function renderHistory() {
            if (state.storyHistory.length === 0) {
                elements.historyContainer.innerHTML = '<p>No stories saved yet.</p>';
                return;
            }
            
            elements.historyContainer.innerHTML = state.storyHistory.map(item => `
                <div class="history-item">
                    <h4>${item.characterName}</h4>
                    <p><strong>Time:</strong> ${item.timePeriod} | <strong>Location:</strong> ${item.locationSetting}</p>
                    <p><strong>Prompt:</strong> ${item.prompt}</p>
                    <p><strong>Story:</strong> ${item.story.substring(0, 100)}...</p>
                </div>
            `).join('');
        }

        // Initialize the app
        function init() {
            initEventListeners();
            renderHistory();
        }

        // Start the app
        init();
    </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "anarko/qwen3-coder-flash:30b";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>
```