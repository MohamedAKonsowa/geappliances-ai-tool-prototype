<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com blob:; worker-src blob:; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org https://cdn.jsdelivr.net; base-uri 'none'; form-action 'none';">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    :root {
      --ge-primary: #007a8a;
      --ge-primary-dark: #005f6b;
      --ge-accent: #f39200;
      --ge-header: #003B64;
      --ge-divider: #B1C2C4;
      --ge-radius: 2px;
      --ge-gutter: 16px;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .ge-dropzone {
      border: 2px dashed var(--ge-divider);
      transition: all 0.3s ease;
    }
    .ge-dropzone.dragover {
      border-color: var(--ge-primary);
      background-color: rgba(0, 122, 138, 0.05);
    }
    .ge-card {
      border-radius: 2px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .ge-header {
      color: var(--ge-header);
    }
    .ge-primary-bg {
      background-color: var(--ge-primary);
    }
    .ge-accent-bg {
      background-color: var(--ge-accent);
    }
    .ge-error-banner {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }
    .large-font {
      font-size: 1.25rem;
    }
    .large-font .text-sm {
      font-size: 1rem;
    }
    .large-font .text-xs {
      font-size: 0.875rem;
    }
    @container (max-width: 640px) {
      .responsive-chart {
        height: 200px !important;
      }
    }
    .focus-outline:focus {
      outline: 2px solid var(--ge-primary);
      outline-offset: 2px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <!-- Upload Section -->
    <div id="upload-section" class="container mx-auto px-4 py-8 max-w-4xl">
      <h1 class="text-3xl font-bold ge-header mb-8 text-center">GE Timesheet Performance Analyzer</h1>
      
      <div id="dropzone" class="ge-dropzone rounded-lg p-12 text-center cursor-pointer hover:bg-gray-50 transition-colors">
        <div class="space-y-4">
          <div class="material-symbols-outlined text-6xl text-gray-400">upload_file</div>
          <div>
            <p class="text-xl font-semibold text-gray-700 mb-2">Drop your CSV file here or click to browse</p>
            <p class="text-sm text-gray-500">Maximum file size: 10 MB</p>
          </div>
          <input type="file" id="fileInput" accept=".csv" class="hidden">
        </div>
      </div>

      <div id="error-banner" class="ge-error-banner rounded-lg p-4 mt-4 hidden">
        <div class="flex items-center">
          <span class="material-symbols-outlined mr-2">error</span>
          <span id="error-message"></span>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="hidden container mx-auto px-4 py-8 max-w-7xl">
      <!-- Controls -->
      <div class="flex flex-wrap gap-4 mb-8 items-center justify-between">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Date Range:</label>
            <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded focus-outline">
            <span class="text-gray-500">to</span>
            <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded focus-outline">
          </div>
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">View:</label>
            <select id="viewMode" class="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-ge-primary">
              <option value="all">All Employees</option>
              <option value="single">Single Employee</option>
            </select>
          </div>
          <select id="employeeSelect" class="hidden px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-ge-primary">
            <option value="">Select Employee</option>
          </select>
        </div>
        <div class="flex items-center space-x-4">
          <button id="fontToggle" class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded transition-colors focus-outline">
            Toggle Large Font
          </button>
          <button id="downloadPdf" class="px-4 py-2 text-sm ge-primary-bg text-white rounded hover:opacity-90 transition-opacity focus-outline">
            Download Report
          </button>
        </div>
      </div>

      <!-- Hero Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div id="bestPerformer" class="ge-card p-6 border-t-4 border-green-500">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">Best Performer – Most Punctual</h2>
          <div class="flex items-start space-x-4">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
              <span class="material-symbols-outlined text-gray-400 text-3xl">person</span>
            </div>
            <div class="flex-1">
              <h3 id="bestName" class="text-xl font-bold text-gray-900 mb-2">-</h3>
              <div class="space-y-1 text-sm text-gray-600">
                <p>Average arrival: <span id="bestArrival" class="font-medium">-</span></p>
                <p>Average departure: <span id="bestDeparture" class="font-medium">-</span></p>
                <p class="text-gray-700 font-medium" id="bestExplanation">-</p>
              </div>
            </div>
          </div>
        </div>

        <div id="worstPerformer" class="ge-card p-6 border-t-4 border-red-500">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">Needs Attention – Least Punctual</h2>
          <div class="flex items-start space-x-4">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
              <span class="material-symbols-outlined text-gray-400 text-3xl">person</span>
            </div>
            <div class="flex-1">
              <h3 id="worstName" class="text-xl font-bold text-gray-900 mb-2">-</h3>
              <div class="space-y-1 text-sm text-gray-600">
                <p>Average arrival: <span id="worstArrival" class="font-medium">-</span></p>
                <p>Average departure: <span id="worstDeparture" class="font-medium">-</span></p>
                <p class="text-gray-700 font-medium" id="worstExplanation">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="ge-card p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Total Deviation Comparison</h3>
        <div class="relative" style="height: 300px">
          <canvas id="deviationChart"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div class="ge-card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Employee Details</h3>
        <div id="employeeTable"></div>
      </div>
    </div>
  </div>

  <script>
    // State
    let csvData = [];
    let employees = [];
    let bestPerformer = null;
    let worstPerformer = null;
    let deviationChart = null;
    let table = null;
    let fontSize = 'normal';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      setupDropzone();
      initializeDates();
    });

    function setupEventListeners() {
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('viewMode').addEventListener('change', handleViewModeChange);
      document.getElementById('startDate').addEventListener('change', updateDashboard);
      document.getElementById('endDate').addEventListener('change', updateDashboard);
      document.getElementById('employeeSelect').addEventListener('change', updateDashboard);
      document.getElementById('fontToggle').addEventListener('click', toggleFontSize);
      document.getElementById('downloadPdf').addEventListener('click', downloadReport);
    }

    function setupDropzone() {
      const dropzone = document.getElementById('dropzone');
      
      dropzone.addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'text/csv') {
          processFile(files[0]);
        }
      });
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file && file.type === 'text/csv' && file.size <= 10 * 1024 * 1024) {
        processFile(file);
      } else {
        showError('Please select a CSV file under 10MB');
      }
    }

    function processFile(file) {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          if (validateData(results.data)) {
            csvData = results.data;
            computeMetrics();
            showDashboard();
          }
        },
        error: (error) => {
          showError('Error parsing CSV: ' + error.message);
        }
      });
    }

    function validateData(data) {
      const requiredColumns = ['employee_id', 'name', 'date', 'clock_in', 'clock_out'];
      const errors = [];

      if (data.length === 0) {
        showError('CSV file is empty');
        return false;
      }

      const headers = Object.keys(data[0]);
      const missingColumns = requiredColumns.filter(col => !headers.includes(col));
      
      if (missingColumns.length > 0) {
        showError(`Missing required columns: ${missingColumns.join(', ')}`);
        return false;
      }

      data.forEach((row, index) => {
        const missingFields = requiredColumns.filter(col => !row[col] || row[col].trim() === '');
        if (missingFields.length > 0) {
          errors.push(`Row ${index + 2}: Missing fields - ${missingFields.join(', ')}`);
        }
      });

      if (errors.length > 0) {
        showError(`Found ${errors.length} malformed rows. First error: ${errors[0]}`);
        return false;
      }

      return true;
    }

    function showError(message) {
      const errorBanner = document.getElementById('error-banner');
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = message;
      errorBanner.classList.remove('hidden');
      setTimeout(() => errorBanner.classList.add('hidden'), 5000);
    }

    function computeMetrics() {
      const employeeMap = {};

      csvData.forEach(row => {
        const employeeId = row.employee_id;
        const name = row.name;
        const date = row.date;
        const clockIn = dayjs(`${date} ${row.clock_in}`);
        const clockOut = dayjs(`${date} ${row.clock_out}`);
        const standardStart = dayjs(`${date} 09:00:00`);
        const standardEnd = dayjs(`${date} 17:00:00`);

        if (!employeeMap[employeeId]) {
          employeeMap[employeeId] = {
            id: employeeId,
            name: name,
            records: []
          };
        }

        const arrivalDelta = Math.max(0, clockIn.diff(standardStart, 'minute'));
        const departureDelta = Math.max(0, standardEnd.diff(clockOut, 'minute'));
        const totalDeviation = arrivalDelta + departureDelta;

        employeeMap[employeeId].records.push({
          date: date,
          arrivalDelta: arrivalDelta,
          departureDelta: departureDelta,
          totalDeviation: totalDeviation
        });
      });

      employees = Object.values(employeeMap).map(emp => {
        const totalRecords = emp.records.length;
        const avgArrivalDelta = emp.records.reduce((sum, r) => sum + r.arrivalDelta, 0) / totalRecords;
        const avgDepartureDelta = emp.records.reduce((sum, r) => sum + r.departureDelta, 0) / totalRecords;
        const avgTotalDeviation = emp.records.reduce((sum, r) => sum + r.totalDeviation, 0) / totalRecords;

        return {
          id: emp.id,
          name: emp.name,
          totalRecords: totalRecords,
          avgArrivalDelta: avgArrivalDelta,
          avgDepartureDelta: avgDepartureDelta,
          avgTotalDeviation: avgTotalDeviation
        };
      });

      employees.sort((a, b) => a.avgTotalDeviation - b.avgTotalDeviation);
      bestPerformer = employees[0];
      worstPerformer = employees[employees.length - 1];
    }

    function showDashboard() {
      document.getElementById('upload-section').classList.add('hidden');
      document.getElementById('dashboard-section').classList.remove('hidden');
      updateEmployeeSelect();
      updateHeroCards();
      updateChart();
      updateTable();
    }

    function updateEmployeeSelect() {
      const select = document.getElementById('employeeSelect');
      select.innerHTML = '<option value="">Select Employee</option>';
      employees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = `${emp.name} (${emp.id})`;
        select.appendChild(option);
      });
    }

    function handleViewModeChange(e) {
      const mode = e.target.value;
      const employeeSelect = document.getElementById('employeeSelect');
      
      if (mode === 'single') {
        employeeSelect.classList.remove('hidden');
        employeeSelect.focus();
      } else {
        employeeSelect.classList.add('hidden');
        updateDashboard();
      }
    }

    function updateDashboard() {
      updateHeroCards();
      updateChart();
      updateTable();
    }

    function getFilteredData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const viewMode = document.getElementById('viewMode').value;
      const selectedEmployee = document.getElementById('employeeSelect').value;

      let filtered = [...employees];

      // Filter by date range if set
      if (startDate || endDate) {
        const filteredCsvData = csvData.filter(row => {
          const rowDate = dayjs(row.date);
          const start = startDate ? dayjs(startDate) : null;
          const end = endDate ? dayjs(endDate) : null;
          
          if (start && rowDate.isBefore(start)) return false;
          if (end && rowDate.isAfter(end)) return false;
          return true;
        });

        // Recompute metrics for filtered data
        if (filteredCsvData.length > 0) {
          const originalCsvData = csvData;
          csvData = filteredCsvData;
          computeMetrics();
          filtered = [...employees];
          csvData = originalCsvData;
          computeMetrics();
        }
      }

      // Filter by single employee if selected
      if (viewMode === 'single' && selectedEmployee) {
        filtered = filtered.filter(emp => emp.id === selectedEmployee);
      }

      return filtered;
    }

    function updateHeroCards() {
      const filtered = getFilteredData();
      if (filtered.length === 0) return;

      const best = filtered[0];
      const worst = filtered[filtered.length - 1];

      // Best performer
      document.getElementById('bestName').textContent = best.name;
      document.getElementById('bestArrival').textContent = formatDelta(best.avgArrivalDelta);
      document.getElementById('bestDeparture').textContent = formatDelta(best.avgDepartureDelta);
      document.getElementById('bestExplanation').textContent = 
        `${best.name} averaged ${formatMinutes(best.avgArrivalDelta)} late to arrive and left ${formatMinutes(best.avgDepartureDelta)} early, totaling ${formatMinutes(best.avgTotalDeviation)} min deviation across ${best.totalRecords} days.`;

      // Worst performer
      document.getElementById('worstName').textContent = worst.name;
      document.getElementById('worstArrival').textContent = formatDelta(worst.avgArrivalDelta);
      document.getElementById('worstDeparture').textContent = formatDelta(worst.avgDepartureDelta);
      document.getElementById('worstExplanation').textContent = 
        `${worst.name} averaged ${formatMinutes(worst.avgArrivalDelta)} late to arrive and left ${formatMinutes(worst.avgDepartureDelta)} early, totaling ${formatMinutes(worst.avgTotalDeviation)} min deviation across ${worst.totalRecords} days.`;
    }

    function formatDelta(minutes) {
      if (minutes === 0) return 'On time';
      const sign = minutes > 0 ? '+' : '';
      return `${sign}${formatMinutes(Math.abs(minutes))}`;
    }

    function formatMinutes(minutes) {
      if (minutes < 1) return '<1 min';
      if (minutes === 1) return '1 min';
      return `${Math.round(minutes)} min`;
    }

    function updateChart() {
      const filtered = getFilteredData();
      const ctx = document.getElementById('deviationChart').getContext('2d');

      if (deviationChart) {
        deviationChart.destroy();
      }

      const labels = filtered.map(emp => emp.name);
      const data = filtered.map(emp => emp.avgTotalDeviation);

      deviationChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Deviation (minutes)',
            data: data,
            backgroundColor: '#007a8a',
            borderColor: '#005f6b',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Minutes'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Employee'
              }
            }
          }
        }
      });
    }

    function updateTable() {
      const filtered = getFilteredData();
      const tableData = filtered.map(emp => ({
        name: emp.name,
        id: emp.id,
        records: emp.totalRecords,
        arrival: formatDelta(emp.avgArrivalDelta),
        departure: formatDelta(emp.avgDepartureDelta),
        total: formatMinutes(emp.avgTotalDeviation)
      }));

      if (table) {
        table.destroy();
      }

      table = new Tabulator('#employeeTable', {
        data: tableData,
        layout: 'fitColumns',
        responsiveLayout: 'collapse',
        columns: [
          { title: 'Name', field: 'name', headerFilter: true, ariaLabel: 'Employee name' },
          { title: 'ID', field: 'id', headerFilter: true, ariaLabel: 'Employee ID' },
          { title: 'Days', field: 'records', sorter: 'number', ariaLabel: 'Number of work days' },
          { title: 'Avg Arrival', field: 'arrival', sorter: 'string', ariaLabel: 'Average arrival time deviation' },
          { title: 'Avg Departure', field: 'departure', sorter: 'string', ariaLabel: 'Average departure time deviation' },
          { title: 'Total Deviation', field: 'total', sorter: 'string', ariaLabel: 'Total schedule deviation' }
        ],
        initialSort: [{ column: 'total', dir: 'asc' }]
      });
    }

    function initializeDates() {
      const today = dayjs().format('YYYY-MM-DD');
      const thirtyDaysAgo = dayjs().subtract(30, 'day').format('YYYY-MM-DD');
      
      document.getElementById('startDate').value = thirtyDaysAgo;
      document.getElementById('endDate').value = today;
    }

    function toggleFontSize() {
      fontSize = fontSize === 'normal' ? 'large' : 'normal';
      document.body.classList.toggle('large-font', fontSize === 'large');
    }

    async function downloadReport() {
      const button = document.getElementById('downloadPdf');
      const originalText = button.textContent;
      button.textContent = 'Generating...';
      button.disabled = true;

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(20);
        doc.setTextColor(0, 59, 100);
        doc.text('GE Timesheet Performance Report', 20, 30);
        
        // Date range
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        doc.text(`Period: ${startDate} to ${endDate}`, 20, 45);
        
        // Best performer
        doc.setFontSize(14);
        doc.setTextColor(0, 122, 138);
        doc.text('Best Performer:', 20, 60);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(document.getElementById('bestName').textContent, 20, 70);
        doc.text(document.getElementById('bestExplanation').textContent, 20, 80);
        
        // Worst performer
        doc.setFontSize(14);
        doc.setTextColor(0, 122, 138);
        doc.text('Needs Attention:', 20, 100);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(document.getElementById('worstName').textContent, 20, 110);
        doc.text(document.getElementById('worstExplanation').textContent, 20, 120);
        
        // Save
        doc.save('ge-timesheet-report.pdf');
        
        Swal.fire({
          title: 'Success!',
          text: 'Report downloaded successfully',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        Swal.fire({
          title: 'Error',
          text: 'Failed to generate PDF report',
          icon: 'error'
        });
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "moonshotai/kimi-k2-instruct-0905";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>