<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org https://cdn.jsdelivr.net; base-uri 'none'; form-action 'none';">
  <meta charset="utf-8">
  <title>GEA Punctuality Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --ge-primary:#007a8a;
      --ge-dark:#005f6b;
      --ge-accent:#f39200;
      --ge-success:#28c840;
      --ge-warning:#ffbd2e;
      --ge-error:#ff5f57;
    }
    body{font-family:'Inter',sans-serif;font-size:16px;}
    .focus-ge:focus{outline:3px solid var(--ge-accent);}
    .ge-btn{
      @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-[var(--ge-primary)] text-white font-semibold;
    }
    .ge-btn:hover{background:var(--ge-dark);}
    @media (prefers-reduced-motion:reduce){
      *{transition:none!important;}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="app" class="min-h-screen flex flex-col">
    <header class="bg-white border-b border-gray-200 px-4 py-4">
      <h1 class="text-xl font-bold">GEA Punctuality Dashboard</h1>
    </header>

    <main id="mainContent" class="flex-1 px-4 py-6">
      <!-- Landing / Upload -->
      <section id="uploadSection" class="max-w-2xl mx-auto">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-lg font-semibold mb-4">Upload Timesheet (CSV)</h2>
          <div id="dropzone"
               class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-[var(--ge-primary)] focus-ge"
               tabindex="0"
               role="button"
               aria-label="Upload CSV file">
            <span class="material-symbols-outlined text-4xl text-gray-400">upload_file</span>
            <p class="mt-2 text-gray-600">Drag & drop or <span class="text-[var(--ge-primary)] font-semibold">browse</span></p>
            <input type="file" id="csvInput" accept=".csv" class="sr-only" aria-label="CSV file input">
          </div>
          <div id="errorBanner" class="hidden mt-4 p-3 rounded bg-red-100 text-red-800"></div>
        </div>
      </section>

      <!-- Processing -->
      <section id="processingSection" class="max-w-2xl mx-auto hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="mb-2">Processing file...</p>
          <div class="w-full bg-gray-200 rounded h-4 overflow-hidden">
            <div id="progressBar" class="bg-[var(--ge-primary)] h-4" style="width:0%"></div>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section id="resultsSection" class="hidden">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Hero Cards -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="material-symbols-outlined text-3xl text-gray-500">person</span>
              </div>
              <div>
                <p id="bestName" class="text-lg font-semibold"></p>
                <span id="bestBadge" class="mt-1 inline-block px-2 py-1 rounded text-white bg-[var(--ge-success)]">Best Performer</span>
                <p id="bestScore" class="mt-1 text-sm text-gray-600"></p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="material-symbols-outlined text-3xl text-gray-500">person</span>
              </div>
              <div>
                <p id="worstName" class="text-lg font-semibold"></p>
                <span id="worstBadge" class="mt-1 inline-block px-2 py-1 rounded text-white bg-[var(--ge-error)]">Needs Improvement</span>
                <p id="worstScore" class="mt-1 text-sm text-gray-600"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparison Chart -->
        <div class="max-w-6xl mx-auto mt-6 bg-white rounded-lg shadow p-6">
          <h3 class="font-semibold mb-4">Best vs Worst Comparison</h3>
          <canvas id="compareChart" aria-label="Comparison chart" role="img"></canvas>
        </div>

        <!-- Ranking Table -->
        <div class="max-w-6xl mx-auto mt-6 bg-white rounded-lg shadow p-6 overflow-x-auto">
          <h3 class="font-semibold mb-4">All Employees (ranked)</h3>
          <table id="rankingTable" class="min-w-full text-sm">
            <thead>
              <tr class="border-b">
                <th scope="col" class="text-left py-2">Name</th>
                <th scope="col" class="text-left py-2">Avg Late In (min)</th>
                <th scope="col" class="text-left py-2">Avg Early/Out (min)</th>
                <th scope="col" class="text-left py-2">Score</th>
              </tr>
            </thead>
            <tbody id="rankingBody"></tbody>
          </table>
        </div>

        <!-- Actions -->
        <div class="max-w-6xl mx-auto mt-6 flex gap-4">
          <button id="downloadBtn" class="ge-btn">Download Report</button>
          <button id="newUploadBtn" class="ge-btn bg-gray-200 text-gray-900 hover:bg-gray-300">Upload New File</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Global state
    let file=null,employees=[],best=null,worst=null,status='idle',progress=0,errorMsg='';

    // Elements
    const dropzone=document.getElementById('dropzone');
    const csvInput=document.getElementById('csvInput');
    const errorBanner=document.getElementById('errorBanner');
    const uploadSection=document.getElementById('uploadSection');
    const processingSection=document.getElementById('processingSection');
    const resultsSection=document.getElementById('resultsSection');
    const progressBar=document.getElementById('progressBar');

    // Drag & Drop handlers
    dropzone.addEventListener('click',()=>csvInput.click());
    dropzone.addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' '){e.preventDefault();csvInput.click();}
    });
    csvInput.addEventListener('change',handleFiles);
    dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('border-[var(--ge-primary)]');});
    dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('border-[var(--ge-primary)]'));
    dropzone.addEventListener('drop',e=>{
      e.preventDefault();
      dropzone.classList.remove('border-[var(--ge-primary)]');
      if(e.dataTransfer.files.length) handleFiles({target:{files:e.dataTransfer.files}});
    });

    function handleFiles(ev){
      const f=ev.target.files[0];
      if(!f) return;
      if(f.type!=='text/csv' && !f.name.endsWith('.csv')){
        showError('Please upload a .csv file.');
        return;
      }
      file=f;
      parseCSV(f);
    }

    function parseCSV(f){
      uploadSection.classList.add('hidden');
      processingSection.classList.remove('hidden');
      errorBanner.classList.add('hidden');
      progress=0;
      const workerCode=`
        self.onmessage=function(e){
          const csv=e.data;
          let len=0,idx=0;
          const lines=csv.split('\\n');
          len=lines.length;
          const result={data:[],errors:[],meta:{}};
          const header=lines[0].split(',').map(s=>s.trim().toLowerCase());
          const required=['employee_id','name','date','clock_in','clock_out'];
          const missing=required.filter(r=>!header.includes(r));
          if(missing.length){
            self.postMessage({type:'error',msg:'Missing columns: '+missing.join(', ')});
            return;
          }
          const headers=lines[0].split(',').map(s=>s.trim());
          for(let i=1;i<lines.length;i++){
            const row={};
            const cells=lines[i].split(',').map(s=>s.trim());
            headers.forEach((h,j)=>row[h]=cells[j]||'');
            if(row.employee_id) result.data.push(row);
            idx=i;
            self.postMessage({type:'progress',value:Math.round((idx/len)*100)});
          }
          self.postMessage({type:'complete',data:result.data});
        };
      `;
      const blob=new Blob([workerCode],{type:'application/javascript'});
      const worker=new Worker(URL.createObjectURL(blob));
      worker.onmessage=function(ev){
        if(ev.data.type==='progress'){
          progress=ev.data.value;
          progressBar.style.width=progress+'%';
        }
        if(ev.data.type==='error'){
          showError(ev.data.msg);
          worker.terminate();
        }
        if(ev.data.type==='complete'){
          const rows=ev.data.data;
          worker.terminate();
          computeScores(rows);
        }
      };
      const reader=new FileReader();
      reader.onload=function(e){worker.postMessage(e.target.result);};
      reader.readAsText(f);
    }

    function computeScores(rows){
      // Group by employee
      const byEmp=_.groupBy(rows,'employee_id');
      const emps=[];
      for(const id in byEmp){
        const records=byEmp[id];
        const name=records[0].name;
        let lateIn=0,earlyOut=0,shiftDev=0,cnt=0;
        const inMins=[],outMins=[],shifts=[];
        records.forEach(r=>{
          const date=r.date;
          const cin=dayjs(date+' '+r.clock_in);
          const cout=dayjs(date+' '+r.clock_out);
          if(!cin.isValid()||!cout.isValid()) return;
          const targetIn=dayjs(date+' 09:00');
          const targetOut=dayjs(date+' 17:00');
          const late=(cin.diff(targetIn,'minute'));
          const early=(targetOut.diff(cout,'minute'));
          const shift=cout.diff(cin,'minute');
          const idealShift=8*60;
          lateIn+=Math.max(0,late);
          earlyOut+=Math.max(0,early);
          shiftDev+=Math.abs(shift-idealShift);
          inMins.push(Math.max(0,late));
          outMins.push(Math.max(0,early));
          shifts.push(shift);
          cnt++;
        });
        if(cnt===0) continue;
        const avgLateIn=lateIn/cnt;
        const avgEarlyOut=earlyOut/cnt;
        const avgShiftDev=shiftDev/cnt;
        const stdIn=ss.standardDeviation(inMins);
        const stdOut=ss.standardDeviation(outMins);
        const consistency=1/(1+(stdIn+stdOut)/2);
        // Weighted score
        const punctualityIn=Math.max(0,100-avgLateIn);
        const punctualityOut=Math.max(0,100-avgEarlyOut);
        const score=0.4*punctualityIn+0.3*punctualityOut+0.3*consistency;
        emps.push({id,name,avgLateIn,avgEarlyOut,score,records});
      }
      employees=_.orderBy(emps,['score'],['desc']);
      best=employees[0];
      worst=employees[employees.length-1];
      renderResults();
    }

    function renderResults(){
      processingSection.classList.add('hidden');
      resultsSection.classList.remove('hidden');
      // Hero cards
      document.getElementById('bestName').textContent=best.name;
      document.getElementById('bestScore').textContent=`Score: ${best.score.toFixed(1)}`;
      document.getElementById('worstName').textContent=worst.name;
      document.getElementById('worstScore').textContent=`Score: ${worst.score.toFixed(1)}`;
      // Compare chart
      const ctx=document.getElementById('compareChart').getContext('2d');
      new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Punctuality In','Punctuality Out','Consistency'],
          datasets:[
            {
              label:best.name,
              data:[Math.max(0,100-best.avgLateIn),Math.max(0,100-best.avgEarlyOut),best.score*0.3],
              backgroundColor:'#28c840'
            },
            {
              label:worst.name,
              data:[Math.max(0,100-worst.avgLateIn),Math.max(0,100-worst.avgEarlyOut),worst.score*0.3],
              backgroundColor:'#ff5f57'
            }
          ]
        },
        options:{
          responsive:true,
          plugins:{legend:{position:'bottom'}},
          scales:{y:{beginAtZero:true,max:100}}
        }
      });
      // Ranking table
      const tbody=document.getElementById('rankingBody');
      tbody.innerHTML='';
      employees.forEach(e=>{
        const tr=document.createElement('tr');
        tr.className='border-b';
        tr.innerHTML=`
          <td class="py-2">${e.name}</td>
          <td class="py-2">${e.avgLateIn.toFixed(1)}</td>
          <td class="py-2">${e.avgEarlyOut.toFixed(1)}</td>
          <td class="py-2">${e.score.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      });
      // Download
      document.getElementById('downloadBtn').addEventListener('click',()=>{
        const doc=new jspdf.jsPDF({orientation:'landscape'});
        doc.text('GEA Punctuality Report',20,20);
        doc.text(`Best: ${best.name} (Score: ${best.score.toFixed(1)})`,20,30);
        doc.text(`Worst: ${worst.name} (Score: ${worst.score.toFixed(1)})`,20,40);
        doc.save('report.pdf');
      });
      // New upload
      document.getElementById('newUploadBtn').addEventListener('click',()=>{
        file=null;employees=[];best=null;worst=null;status='idle';progress=0;
        resultsSection.classList.add('hidden');
        uploadSection.classList.remove('hidden');
      });
      // Toast
      Swal.fire({title:'Success',text:'File processed.',icon:'success',timer:2000,showConfirmButton:false});
    }

    function showError(msg){
      errorMsg=msg;
      errorBanner.textContent=msg;
      errorBanner.classList.remove('hidden');
      uploadSection.classList.remove('hidden');
      processingSection.classList.add('hidden');
    }
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "moonshotai/kimi-k2-instruct";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>