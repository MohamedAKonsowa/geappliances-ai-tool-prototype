<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
<meta charset="UTF-8">
<title>Timesheet Performance Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --color-primary:#007a8a;
    --color-primary-dark:#005f6b;
    --color-accent:#f39200;
    --color-success:#28c840;
    --color-warning:#ffbd2e;
    --color-error:#ff5f57;
    --bg-light:#f5f5f5;
    --bg-dark:#1e1e1e;
    --text-light:#111;
    --text-dark:#eee;
  }
  [data-theme="light"] {
    --bg:var(--bg-light);
    --text:var(--text-light);
    --card-bg:#fff;
    --card-border:#ddd;
  }
  [data-theme="dark"] {
    --bg:var(--bg-dark);
    --text:var(--text-dark);
    --card-bg:#2b2b2b;
    --card-border:#444;
  }
  body{
    margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);
    display:flex;flex-direction:column;min-height:100vh;
  }
  header{padding:1rem;background:var(--color-primary);color:#fff;display:flex;justify-content:space-between;align-items:center;}
  header h1{margin:0;font-size:1.25rem;}
  .toggle-btn{background:none;border:none;color:#fff;cursor:pointer;font-size:1rem;}
  main{flex:1;padding:1rem;max-width:1200px;margin:auto;width:100%;}
  .upload-zone{
    border:2px dashed var(--color-primary);border-radius:8px;padding:2rem;text-align:center;
    cursor:pointer;transition:background .2s;
  }
  .upload-zone.dragover{background:rgba(0,122,138,0.1);}
  .cards{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem;}
  .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:1rem;flex:1;min-width:260px;position:relative;}
  .card h2{margin:0 0 .5rem;font-size:1rem;color:var(--color-primary-dark);}
  .card button{margin-top:.5rem;background:var(--color-primary);color:#fff;border:none;padding:.4rem .8rem;border-radius:4px;cursor:pointer;}
  .chart-container{margin-top:2rem;overflow-x:auto;}
  svg{font-family:'Inter',sans-serif;}
  table{width:100%;border-collapse:collapse;margin-top:1rem;background:var(--card-bg);}
  th,td{padding:.5rem;border:1px solid var(--card-border);text-align:left;}
  th{cursor:pointer;background:var(--color-primary);color:#fff;position:sticky;top:0;}
  th.sort-asc::after{content:" â–²";}
  th.sort-desc::after{content:" â–¼";}
  .filter-input{margin-top:.5rem;padding:.4rem;width:100%;border:1px solid var(--card-border);border-radius:4px;}
  .modal-backdrop{
    position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);
    display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;
    transition:opacity .3s;
  }
  .modal-backdrop.show{opacity:1;pointer-events:auto;}
  .modal{
    background:var(--card-bg);color:var(--text);padding:1.5rem;border-radius:8px;max-width:500px;width:90%;position:relative;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  .modal h3{margin-top:0;}
  .close-modal{
    position:absolute;top:.5rem;right:.5rem;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text);
  }
  .toast{
    position:fixed;bottom:1rem;right:1rem;background:var(--color-primary);color:#fff;padding:.8rem 1rem;border-radius:4px;
    opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s;
  }
  .toast.show{opacity:1;transform:translateY(0);}
  .loading-overlay{
    position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);
    display:flex;align-items:center;justify-content:center;z-index:2000;display:none;
  }
  .spinner{
    border:4px solid #ccc;border-top:4px solid var(--color-primary);border-radius:50%;width:40px;height:40px;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}
  footer{padding:1rem;text-align:center;font-size:.9rem;color:var(--text);}
</style>
</head>
<body>
<header>
  <h1>Timesheet Performance Analyzer</h1>
  <button class="toggle-btn" aria-label="Toggle dark mode">ðŸŒ™</button>
</header>
<main>
  <div class="upload-zone" id="uploadZone" tabindex="0" aria-label="Upload CSV file">
    Drag & drop CSV here or click to browse
    <input type="file" id="fileInput" accept=".csv" style="display:none;">
  </div>
  <div class="cards" id="cardsContainer" style="display:none;">
    <div class="card" id="bestCard">
      <h2>Best Performer</h2>
      <p id="bestInfo"></p>
      <button data-type="best">Why?</button>
    </div>
    <div class="card" id="worstCard">
      <h2>Worst Performer</h2>
      <p id="worstInfo"></p>
      <button data-type="worst">Why?</button>
    </div>
  </div>
  <div class="chart-container" id="chartContainer" style="display:none;">
    <svg id="deviationChart" height="200"></svg>
  </div>
  <input type="text" id="filterInput" class="filter-input" placeholder="Filter by name...">
  <table id="metricsTable" style="display:none;">
    <thead>
      <tr>
        <th data-col="employee_id">ID</th>
        <th data-col="name">Name</th>
        <th data-col="avgLateMins">Avg Late (mins)</th>
        <th data-col="avgEarlyMins">Avg Early (mins)</th>
        <th data-col="totalDeviation">Total Deviation</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="close-modal" aria-label="Close">&times;</button>
    <h3 id="modalTitle"></h3>
    <p id="modalContent"></p>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

<footer>Â© 2026 GE Appliances â€“ Version 1.0</footer>

<script>
(() => {
  // State
  const state = {
    rawRows: [],
    employees: [],
    bestEmployee: null,
    worstEmployee: null,
    theme: localStorage.getItem('theme') || 'light',
    showExplanationModal: false,
    modalEmployee: null,
    modalType: '',
    explanationText: '',
    loading: false,
    sortState: { column: 'employee_id', direction: 'asc' },
    filterText: ''
  };

  // Elements
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const toastEl = document.getElementById('toast');
  const bestCard = document.getElementById('bestCard');
  const worstCard = document.getElementById('worstCard');
  const bestInfo = document.getElementById('bestInfo');
  const worstInfo = document.getElementById('worstInfo');
  const cardsContainer = document.getElementById('cardsContainer');
  const chartContainer = document.getElementById('chartContainer');
  const chartSvg = document.getElementById('deviationChart');
  const table = document.getElementById('metricsTable');
  const tbody = table.querySelector('tbody');
  const filterInput = document.getElementById('filterInput');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const closeModalBtn = modalBackdrop.querySelector('.close-modal');
  const themeToggleBtn = document.querySelector('.toggle-btn');

  // Util
  const showToast = (msg, type='success') => {
    toastEl.textContent = msg;
    toastEl.style.background = type==='error'? 'var(--color-error)' : 'var(--color-success)';
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'),3000);
  };
  const setLoading = (val) => {
    state.loading = val;
    loadingOverlay.style.display = val ? 'flex' : 'none';
  };
  const parseCSV = (text) => {
    const lines = text.trim().split('\n');
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',');
      if(cols.length<5) continue;
      rows.push({
        employee_id: cols[0].trim(),
        name: cols[1].trim(),
        date: cols[2].trim(),
        clock_in: cols[3].trim(),
        clock_out: cols[4].trim()
      });
    }
    return rows;
  };
  const timeToMins = (t)=>{ const [h,m]=t.split(':').map(Number); return h*60+m; };
  const computeMetrics = () => {
    const map = {};
    state.rawRows.forEach(r=>{
      const inMins = timeToMins(r.clock_in);
      const outMins = timeToMins(r.clock_out);
      const late = Math.max(0, inMins - 9*60);
      const early = Math.max(0, 17*60 - outMins);
      if(!map[r.employee_id]){
        map[r.employee_id]={employee_id:r.employee_id,name:r.name,totalLate:0,totalEarly:0,count:0};
      }
      map[r.employee_id].totalLate+=late;
      map[r.employee_id].totalEarly+=early;
      map[r.employee_id].count++;
    });
    state.employees = Object.values(map).map(e=>{
      const avgLate = +(e.totalLate/e.count).toFixed(2);
      const avgEarly = +(e.totalEarly/e.count).toFixed(2);
      const totalDeviation = +(avgLate+avgEarly).toFixed(2);
      return {employee_id:e.employee_id,name:e.name,avgLateMins:avgLate,avgEarlyMins:avgEarly,totalDeviation};
    });
    if(state.employees.length){
      state.bestEmployee = state.employees.reduce((a,b)=>a.totalDeviation<b.totalDeviation?a:b);
      state.worstEmployee = state.employees.reduce((a,b)=>a.totalDeviation>b.totalDeviation?a:b);
    }
  };
  const renderCards = () => {
    if(!state.bestEmployee||!state.worstEmployee){cardsContainer.style.display='none';return;}
    bestInfo.textContent = `${state.bestEmployee.name} (Deviation: ${state.bestEmployee.totalDeviation} mins)`;
    worstInfo.textContent = `${state.worstEmployee.name} (Deviation: ${state.worstEmployee.totalDeviation} mins)`;
    cardsContainer.style.display='flex';
  };
  const renderChart = () => {
    if(!state.employees.length){chartContainer.style.display='none';return;}
    const width = Math.max(500, state.employees.length*120);
    const barHeight = 30;
    const gap = 10;
    const maxDev = Math.max(...state.employees.map(e=>e.totalDeviation));
    const svgHeight = (barHeight+gap)*state.employees.length;
    chartSvg.setAttribute('width', width);
    chartSvg.setAttribute('height', svgHeight);
    chartSvg.innerHTML = '';
    state.employees.forEach((e,i)=>{
      const barWidth = (e.totalDeviation/maxDev)* (width-150);
      const y = i*(barHeight+gap);
      const color = e.employee_id===state.bestEmployee.employee_id ? 'var(--color-success)' :
                    e.employee_id===state.worstEmployee.employee_id ? 'var(--color-error)' : '#4a90e2';
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',150);
      rect.setAttribute('y',y);
      rect.setAttribute('width',barWidth);
      rect.setAttribute('height',barHeight);
      rect.setAttribute('fill',color);
      chartSvg.appendChild(rect);
      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',145);
      txt.setAttribute('y',y+barHeight/2+5);
      txt.setAttribute('text-anchor','end');
      txt.textContent = e.name;
      chartSvg.appendChild(txt);
      const val = document.createElementNS('http://www.w3.org/2000/svg','text');
      val.setAttribute('x',150+barWidth+5);
      val.setAttribute('y',y+barHeight/2+5);
      val.textContent = e.totalDeviation;
      chartSvg.appendChild(val);
    });
    chartContainer.style.display='block';
  };
  const renderTable = () => {
    if(!state.employees.length){table.style.display='none';return;}
    let rows = [...state.employees];
    // filter
    if(state.filterText){
      const ft = state.filterText.toLowerCase();
      rows = rows.filter(r=>r.name.toLowerCase().includes(ft));
    }
    // sort
    rows.sort((a,b)=>{
      const col = state.sortState.column;
      const dir = state.sortState.direction==='asc'?1:-1;
      if(a[col] < b[col]) return -1*dir;
      if(a[col] > b[col]) return 1*dir;
      return 0;
    });
    tbody.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.employee_id}</td>
        <td>${r.name}</td>
        <td>${r.avgLateMins}</td>
        <td>${r.avgEarlyMins}</td>
        <td>${r.totalDeviation}</td>
      `;
      tbody.appendChild(tr);
    });
    table.style.display='table';
  };
  const updateUI = () => {
    renderCards();
    renderChart();
    renderTable();
  };
  const loadFromStorage = () => {
    const stored = localStorage.getItem('analysis');
    if(stored){
      const data = JSON.parse(stored);
      state.rawRows = data.rawRows||[];
      computeMetrics();
      updateUI();
    }
    applyTheme();
  };
  const saveToStorage = () => {
    const data = {rawRows:state.rawRows};
    localStorage.setItem('analysis',JSON.stringify(data));
  };
  const applyTheme = () => {
    document.documentElement.setAttribute('data-theme',state.theme);
    themeToggleBtn.textContent = state.theme==='light'?'ðŸŒ™':'â˜€ï¸';
  };
  const toggleTheme = () => {
    state.theme = state.theme==='light'?'dark':'light';
    localStorage.setItem('theme',state.theme);
    applyTheme();
  };
  // File handling
  const handleFile = (file) => {
    if(!file.name.toLowerCase().endsWith('.csv')){
      showToast('Please upload a CSV file.', 'error');
      return;
    }
    setLoading(true);
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        state.rawRows = parseCSV(e.target.result);
        computeMetrics();
        saveToStorage();
        updateUI();
        showToast('File processed successfully.');
      }catch(err){
        console.error(err);
        showToast('Error processing file.', 'error');
      }finally{
        setLoading(false);
      }
    };
    reader.onerror = ()=>{showToast('Failed to read file.', 'error'); setLoading(false);};
    reader.readAsText(file);
  };
  // Drag & Drop
  uploadZone.addEventListener('click',()=>fileInput.click());
  uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover');});
  uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
  uploadZone.addEventListener('drop',e=>{
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change',()=>{if(fileInput.files[0]) handleFile(fileInput.files[0]);});
  // Table sorting
  table.querySelectorAll('th').forEach(th=>{
    th.addEventListener('click',()=> {
      const col = th.dataset.col;
      if(state.sortState.column===col){
        state.sortState.direction = state.sortState.direction==='asc'?'desc':'asc';
      }else{
        state.sortState.column=col;
        state.sortState.direction='asc';
      }
      table.querySelectorAll('th').forEach(t=>t.classList.remove('sort-asc','sort-desc'));
      th.classList.add(state.sortState.direction==='asc'?'sort-asc':'sort-desc');
      renderTable();
    });
  });
  // Filter
  filterInput.addEventListener('input',()=>{state.filterText=filterInput.value;renderTable();});
  // Modal handling
  const openModal = async (type) => {
    const emp = type==='best'?state.bestEmployee:state.worstEmployee;
    if(!emp) return;
    state.modalEmployee=emp;
    state.modalType=type;
    modalTitle.textContent = type==='best' ? 'Why is this employee the best?' : 'Why is this employee the worst?';
    modalContent.textContent='Generating explanation...';
    modalBackdrop.classList.add('show');
    try{
      const prompt = `Explain why ${emp.name} (${emp.employee_id}) has a total deviation of ${emp.totalDeviation} minutes, with average late ${emp.avgLateMins} minutes and average early leave ${emp.avgEarlyMins} minutes, compared to other employees.`;
      const response = await window.geaRuntimeLLM(prompt);
      state.explanationText = response || '';
    }catch{
      state.explanationText = '';
    }
    if(!state.explanationText){
      state.explanationText = `${emp.name} has a ${type==='best'?'lowest':'highest'} total deviation of ${emp.totalDeviation} minutes (average late ${emp.avgLateMins} mins, average early ${emp.avgEarlyMins} mins).`;
    }
    modalContent.textContent = state.explanationText;
  };
  bestCard.querySelector('button').addEventListener('click',()=>openModal('best'));
  worstCard.querySelector('button').addEventListener('click',()=>openModal('worst'));
  const closeModal = ()=>{modalBackdrop.classList.remove('show');state.showExplanationModal=false;}
  closeModalBtn.addEventListener('click',closeModal);
  modalBackdrop.addEventListener('click',e=>{if(e.target===modalBackdrop) closeModal();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape' && modalBackdrop.classList.contains('show')) closeModal();});
  // Theme toggle
  themeToggleBtn.addEventListener('click',toggleTheme);
  // Init
  loadFromStorage();
})();
</script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "openai/gpt-oss-120b";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>