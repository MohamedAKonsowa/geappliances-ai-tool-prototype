<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com blob:; worker-src blob:; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org https://cdn.jsdelivr.net; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV Content Analyzer</title>
  <script src='https://cdn.tailwindcss.com'></script>
  <script src='https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
  <script src='https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js'></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
</head>
<body class="h-screen flex justify-center items-center">
  <div class="card bg-base-100 shadow-xl w-1/2">
    <div class="card-body">
      <h2 class="card-title">CSV Content Analyzer</h2>
      <input type="file" id="csvFile" accept=".csv" class="block mb-4">
      <button id="uploadButton" class="btn btn-primary">Upload CSV</button>
      <div id="loading" class="hidden flex justify-center items-center">
        <div class="animate-spin h-12 w-12 border-4 border-white border-t-transparent rounded-full"></div>
      </div>
      <div id="results" class="hidden">
        <h3 class="card-title">AI Summary</h3>
        <p id="aiSummary"></p>
        <h3 class="card-title">Column Preview</h3>
        <table id="columnPreview" class="table table-zebra w-full"></table>
      </div>
    </div>
  </div>
  <script>
    const csvFileInput = document.getElementById('csvFile');
    const uploadButton = document.getElementById('uploadButton');
    const loadingOverlay = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const aiSummaryParagraph = document.getElementById('aiSummary');
    const columnPreviewTable = document.getElementById('columnPreview');
    let rawCsvText = '';
    let parsedRows = [];
    let columnNames = [];
    let aiSummary = '';
    let confidenceScore = 0;

    csvFileInput.addEventListener('change', handleFileUpload);
    uploadButton.addEventListener('click', handleUploadClick);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          rawCsvText = reader.result;
          parseCsv();
        };
        reader.readAsText(file);
      }
    }

    function handleUploadClick() {
      if (rawCsvText) {
        parseCsv();
      } else {
        Swal.fire('No CSV file selected');
      }
    }

    function parseCsv() {
      try {
        const csvData = Papa.parse(rawCsvText, { header: true });
        parsedRows = csvData.data;
        columnNames = csvData.meta.fields;
        showLoading(true);
        getAiSummary();
      } catch (error) {
        Swal.fire('Error parsing CSV file');
      }
    }

    function getAiSummary() {
      const first200Rows = parsedRows.slice(0, 200);
      const csvData = first200Rows.map(row => Object.values(row)).join('\n');
      window.geaRuntimeLLM(`Analyze this CSV data: ${csvData}`)
        .then(response => {
          aiSummary = response;
          confidenceScore = 0.8; // placeholder confidence score
          showResults();
        })
        .catch(error => {
          Swal.fire('Error generating AI summary');
        });
    }

    function showLoading(show) {
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    function showResults() {
      showLoading(false);
      resultsDiv.classList.remove('hidden');
      aiSummaryParagraph.textContent = aiSummary;
      const columnPreviewHtml = columnNames.map(column => `<th>${column}</th>`).join('');
      columnPreviewTable.innerHTML = `
        <thead>
          <tr>
            ${columnPreviewHtml}
          </tr>
        </thead>
        <tbody>
          ${parsedRows.slice(0, 5).map(row => `
            <tr>
              ${row.map(cell => `<td>${cell}</td>`).join('')}
            </tr>
          `).join('')}
        </tbody>
      `;
    }
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window._geaRuntimeInjected) return;
  window._geaRuntimeInjected = true;
  
  const defaultModel = "llama-3.3-70b-versatile";
  const appId = "dsstar_20260121_143816_492";
  
  // AI Helper
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;

  // Data Store Helper
  window.geaRuntimeStore = {
    async get(key) {
      const response = await fetch('/api/runtime/store/' + encodeURIComponent(key), {
        headers: { 'X-App-ID': appId }
      });
      if (!response.ok) return null;
      return await response.json().catch(() => null);
    },
    async set(key, value) {
      const response = await fetch('/api/runtime/store/' + encodeURIComponent(key), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-App-ID': appId },
        body: JSON.stringify(value)
      });
      return response.ok;
    }
  };
})();
</script>
</body>
</html>