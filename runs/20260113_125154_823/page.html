<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
  <title>Employee Evaluation App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }
    .nav-bar {
      background-color: #007a8a;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-bar a {
      color: #fff;
      text-decoration: none;
      margin-right: 20px;
    }
    .nav-bar a:hover {
      color: #ccc;
    }
    .file-upload-component {
      margin: 2rem;
    }
    .file-upload-component input[type="file"] {
      display: none;
    }
    .file-upload-component label {
      background-color: #007a8a;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .data-table {
      margin: 2rem;
    }
    .data-table table {
      border-collapse: collapse;
      width: 100%;
    }
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .chart-component {
      margin: 2rem;
    }
    .chart-component canvas {
      width: 100%;
      height: 400px;
    }
    .report-component {
      margin: 2rem;
    }
    .report-component p {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <nav class="nav-bar">
    <a href="#home">Home</a>
    <a href="#dashboard">Dashboard</a>
    <a href="#data-table">Data Table</a>
    <a href="#chart">Chart</a>
    <a href="#report">Report</a>
  </nav>
  <div id="home">
    <h1>Employee Evaluation App</h1>
    <div class="file-upload-component">
      <label for="file">Upload CSV file</label>
      <input type="file" id="file" accept=".csv">
      <progress id="progress" value="0" max="100"></progress>
    </div>
  </div>
  <div id="dashboard">
    <h1>Dashboard</h1>
    <p>Total hours worked: <span id="total-hours"></span></p>
    <p>Average hours worked per day: <span id="average-hours"></span></p>
  </div>
  <div id="data-table">
    <h1>Data Table</h1>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Employee ID</th>
          <th>Date</th>
          <th>Clock-in time</th>
          <th>Clock-out time</th>
        </tr>
      </thead>
      <tbody id="data-table-body">
      </tbody>
    </table>
  </div>
  <div id="chart">
    <h1>Chart</h1>
    <canvas id="chart-canvas"></canvas>
  </div>
  <div id="report">
    <h1>Report</h1>
    <p id="report-text"></p>
  </div>
  <script>
    const fileInput = document.getElementById('file');
    const progressBar = document.getElementById('progress');
    const totalHoursSpan = document.getElementById('total-hours');
    const averageHoursSpan = document.getElementById('average-hours');
    const dataTableBody = document.getElementById('data-table-body');
    const chartCanvas = document.getElementById('chart-canvas');
    const reportText = document.getElementById('report-text');

    let uploadedFile;
    let calculatedMetrics;

    fileInput.addEventListener('change', (e) => {
      uploadedFile = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const csvData = e.target.result;
        const data = Papa.parse(csvData, { header: true }).data;
        const metrics = calculateMetrics(data);
        calculatedMetrics = metrics;
        updateDashboard(metrics);
        updateDataTable(data);
        updateChart(metrics);
        updateReport(metrics);
      };
      reader.readAsText(uploadedFile);
    });

    function calculateMetrics(data) {
      const totalHours = data.reduce((acc, row) => acc + dayjs(row['Clock-out time']).diff(dayjs(row['Clock-in time']), 'hours'), 0);
      const averageHours = totalHours / data.length;
      return { totalHours, averageHours };
    }

    function updateDashboard(metrics) {
      totalHoursSpan.textContent = metrics.totalHours;
      averageHoursSpan.textContent = metrics.averageHours;
    }

    function updateDataTable(data) {
      const rows = data.map((row) => {
        return `
          <tr>
            <td>${row['Name']}</td>
            <td>${row['Employee ID']}</td>
            <td>${row['Date']}</td>
            <td>${row['Clock-in time']}</td>
            <td>${row['Clock-out time']}</td>
          </tr>
        `;
      }).join('');
      dataTableBody.innerHTML = rows;
    }

    function updateChart(metrics) {
      const ctx = chartCanvas.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total hours', 'Average hours'],
          datasets: [{
            label: 'Metrics',
            data: [metrics.totalHours, metrics.averageHours],
            backgroundColor: [
              'rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
            ],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function updateReport(metrics) {
      reportText.textContent = `Total hours worked: ${metrics.totalHours}, Average hours worked per day: ${metrics.averageHours}`;
    }
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "llama-3.3-70b-versatile";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>