<!DOCTYPE html>
<html lang="en" class="h-full" x-data="app()" x-init="init()">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8">
  <title>Timesheet Performance Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind & DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  <style>
    html, body { height: 100%; }
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #007a8a; background-color: #f0f9ff; }
  </style>
</head>
<body class="bg-base-200 text-base-content flex flex-col min-h-full" :class="theme">
  <!-- Header -->
  <header class="navbar bg-base-100 shadow-md">
    <div class="flex-1">
      <a class="btn btn-ghost normal-case text-xl">Timesheet Performance Analyzer</a>
    </div>
    <div class="flex gap-2 items-center">
      <button class="btn btn-ghost" @click="toggleTheme()" aria-label="Toggle dark mode">
        <i data-lucide="moon" x-show="theme === 'light'"></i>
        <i data-lucide="sun" x-show="theme === 'dark'"></i>
      </button>
      <button class="btn btn-ghost" @click="resetApp()" aria-label="Reset app">
        <i data-lucide="refresh-ccw"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 container mx-auto p-4 grid gap-6" :class="{'grid-cols-1': !hasData, 'grid-cols-1 lg:grid-cols-2': hasData}">
    <!-- Upload Section -->
    <section x-show="!hasData" class="flex flex-col items-center justify-center">
      <div class="dropzone w-full max-w-xl p-12 text-center rounded-lg cursor-pointer"
           @dragover.prevent="dragover=true" @dragleave.prevent="dragover=false"
           @drop.prevent="handleDrop($event)" :class="{'dragover': dragover}"
           @click="$refs.fileInput.click()" aria-label="Upload CSV">
        <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto mb-4 text-primary"></i>
        <p class="text-lg font-medium">Drag & drop your CSV file here, or click to select</p>
        <p class="text-sm text-gray-500 mt-2">Accepted format: .csv</p>
        <input type="file" accept=".csv" class="hidden" x-ref="fileInput" @change="handleFiles($event.target.files)">
      </div>
    </section>

    <!-- Analysis Section -->
    <section x-show="hasData" class="space-y-6">
      <!-- Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Best Performer -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-success">Best Performer</h2>
            <p class="font-medium" x-text="bestEmployee?.name"></p>
            <ul class="list-disc list-inside text-sm">
              <li>Avg Late: <span x-text="bestEmployee?.avgLateMins.toFixed(2)"></span> mins</li>
              <li>Avg Early Leave: <span x-text="bestEmployee?.avgEarlyMins.toFixed(2)"></span> mins</li>
              <li>Total Deviation: <span x-text="bestEmployee?.totalDeviation.toFixed(2)"></span> mins</li>
            </ul>
            <button class="btn btn-sm btn-success mt-2" @click="showExplanation(bestEmployee)" aria-label="Why?">Why?</button>
          </div>
        </div>
        <!-- Worst Performer -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-error">Worst Performer</h2>
            <p class="font-medium" x-text="worstEmployee?.name"></p>
            <ul class="list-disc list-inside text-sm">
              <li>Avg Late: <span x-text="worstEmployee?.avgLateMins.toFixed(2)"></span> mins</li>
              <li>Avg Early Leave: <span x-text="worstEmployee?.avgEarlyMins.toFixed(2)"></span> mins</li>
              <li>Total Deviation: <span x-text="worstEmployee?.totalDeviation.toFixed(2)"></span> mins</li>
            </ul>
            <button class="btn btn-sm btn-error mt-2" @click="showExplanation(worstEmployee)" aria-label="Why?">Why?</button>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Total Deviation per Employee</h2>
          <canvas id="deviationChart" class="w-full h-64"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Employee Metrics</h2>
          <div class="overflow-x-auto">
            <table id="employeeTable" class="table w-full">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Name</th>
                  <th class="text-right">Avg Late (min)</th>
                  <th class="text-right">Avg Early (min)</th>
                  <th class="text-right">Total Deviation (min)</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="emp in employees" :key="emp.employee_id">
                  <tr @click="showExplanation(emp)" class="cursor-pointer hover:bg-base-200">
                    <td x-text="emp.employee_id"></td>
                    <td x-text="emp.name"></td>
                    <td class="text-right" x-text="emp.avgLateMins.toFixed(2)"></td>
                    <td class="text-right" x-text="emp.avgEarlyMins.toFixed(2)"></td>
                    <td class="text-right font-bold" :class="{'text-success': emp.employee_id===bestEmployee?.employee_id, 'text-error': emp.employee_id===worstEmployee?.employee_id}" x-text="emp.totalDeviation.toFixed(2)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Explanation Modal -->
  <div x-show="showExplanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.away="showExplanationModal=false">
    <div class="bg-base-100 rounded-lg shadow-xl max-w-lg w-full p-6 relative">
      <button class="absolute top-2 right-2 btn btn-ghost btn-sm" @click="showExplanationModal=false" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
      <h3 class="text-xl font-bold mb-4" x-text="modalEmployee?.name"></h3>
      <p class="whitespace-pre-line" x-html="explanationText"></p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer items-center p-4 bg-base-300 text-base-content">
    <div class="flex-1 text-center">
      <p>GE Appliances • Timesheet Analyzer • v1.0</p>
    </div>
  </footer>

  <script>
    // Alpine component
    function app() {
      return {
        // State
        uploadedFile: null,
        rawRows: [],
        employees: [],
        bestEmployee: null,
        worstEmployee: null,
        theme: localStorage.getItem('theme') || 'light',
        dragover: false,
        showExplanationModal: false,
        modalEmployee: null,
        explanationText: '',
        hasData: false,

        init() {
          lucide.createIcons();
          document.documentElement.classList.toggle('dark', this.theme === 'dark');
          const stored = localStorage.getItem('timesheetEmployees');
          if (stored) {
            this.employees = JSON.parse(stored);
            this.computeBestWorst();
            this.$nextTick(() => {
              this.renderChart();
              this.initTable();
            });
            this.hasData = true;
          }
        },

        toggleTheme() {
          this.theme = this.theme === 'light' ? 'dark' : 'light';
          localStorage.setItem('theme', this.theme);
          document.documentElement.classList.toggle('dark', this.theme === 'dark');
        },

        resetApp() {
          Swal.fire({
            title: 'Reset Application?',
            text: 'All data will be cleared.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, reset',
          }).then((result) => {
            if (result.isConfirmed) {
              localStorage.removeItem('timesheetEmployees');
              localStorage.removeItem('theme');
              location.reload();
            }
          });
        },

        handleFiles(files) {
          const file = files[0];
          if (!file) return;
          if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            Swal.fire({ toast: true, icon: 'error', title: 'Please upload a CSV file.', position: 'top-end', timer: 3000, showConfirmButton: false });
            return;
          }
          this.uploadedFile = file;
          this.processFile();
        },

        handleDrop(e) {
          this.dragover = false;
          const dt = e.dataTransfer;
          if (dt.files && dt.files.length) {
            this.handleFiles(dt.files);
          }
        },

        processFile() {
          Swal.fire({ title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          Papa.parse(this.uploadedFile, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              Swal.close();
              if (results.errors.length) {
                Swal.fire({ toast: true, icon: 'error', title: 'Error parsing CSV.', position: 'top-end', timer: 3000, showConfirmButton: false });
                return;
              }
              this.rawRows = results.data;
              this.computeMetrics();
            },
            error: () => {
              Swal.close();
              Swal.fire({ toast: true, icon: 'error', title: 'Failed to read file.', position: 'top-end', timer: 3000, showConfirmButton: false });
            }
          });
        },

        timeToMins(t) {
          const [h, m] = t.split(':').map(Number);
          return h * 60 + m;
        },

        computeMetrics() {
          const empMap = {};
          this.rawRows.forEach(row => {
            const empId = row.employee_id;
            const name = row.name;
            const clockIn = this.timeToMins(row.clock_in);
            const clockOut = this.timeToMins(row.clock_out);
            const late = Math.max(0, clockIn - 9 * 60);
            const early = Math.max(0, 17 * 60 - clockOut);
            if (!empMap[empId]) {
              empMap[empId] = { employee_id: empId, name, totalLate: 0, totalEarly: 0, days: 0 };
            }
            empMap[empId].totalLate += late;
            empMap[empId].totalEarly += early;
            empMap[empId].days += 1;
          });
          this.employees = Object.values(empMap).map(e => ({
            employee_id: e.employee_id,
            name: e.name,
            avgLateMins: e.totalLate / e.days,
            avgEarlyMins: e.totalEarly / e.days,
            totalDeviation: (e.totalLate + e.totalEarly) / e.days,
          }));
          // Save
          localStorage.setItem('timesheetEmployees', JSON.stringify(this.employees));
          this.computeBestWorst();
          this.$nextTick(() => {
            this.renderChart();
            this.initTable();
          });
          this.hasData = true;
          Swal.fire({ toast: true, icon: 'success', title: 'Analysis complete.', position: 'top-end', timer: 2000, showConfirmButton: false });
        },

        computeBestWorst() {
          if (!this.employees.length) return;
          this.bestEmployee = this.employees.reduce((a, b) => (a.totalDeviation < b.totalDeviation ? a : b));
          this.worstEmployee = this.employees.reduce((a, b) => (a.totalDeviation > b.totalDeviation ? a : b));
        },

        renderChart() {
          const ctx = document.getElementById('deviationChart').getContext('2d');
          const labels = this.employees.map(e => e.name);
          const data = this.employees.map(e => e.totalDeviation);
          const bgColors = this.employees.map(e => {
            if (e.employee_id === this.bestEmployee.employee_id) return '#28c840';
            if (e.employee_id === this.worstEmployee.employee_id) return '#ff5f57';
            return '#007a8a';
          });
          if (window.deviationChart) window.deviationChart.destroy();
          window.deviationChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Total Deviation (min)',
                data,
                backgroundColor: bgColors,
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)} min` } }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        },

        initTable() {
          const tableEl = document.getElementById('employeeTable');
          if (window.employeeDataTable) window.employeeDataTable.destroy();
          window.employeeDataTable = new simpleDatatables.DataTable(tableEl, {
            searchable: true,
            fixedHeight: true,
            perPage: 5,
          });
        },

        async showExplanation(emp) {
          this.modalEmployee = emp;
          const prompt = `Explain why ${emp.name} (Employee ID ${emp.employee_id}) is considered the ${emp.employee_id===this.bestEmployee?.employee_id ? 'best' : 'worst'} performer based on the following metrics: average late arrival ${emp.avgLateMins.toFixed(2)} minutes, average early leave ${emp.avgEarlyMins.toFixed(2)} minutes, total deviation ${emp.totalDeviation.toFixed(2)} minutes. Provide a concise, professional explanation.`;
          try {
            const resp = await window.geaRuntimeLLM(prompt);
            this.explanationText = resp || `<em>No AI response received.</em>`;
          } catch (e) {
            this.explanationText = `<em>Failed to get AI explanation.</em>`;
          }
          this.showExplanationModal = true;
        },
      };
    }
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "openai/gpt-oss-120b";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>