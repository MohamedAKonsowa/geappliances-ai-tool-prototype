<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Local LLM Web Pipeline Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; base-uri 'none'; form-action 'self';">
    <style>
      :root {
        --ink: #1f2a44;
        --ink-soft: #374461;
        --mint: #3aa486;
        --mint-dark: #2a7a63;
        --sand: #f4efe2;
        --sand-deep: #e6dcc7;
        --cream: #fffaf1;
        --rose: #f2d8c9;
        --shadow: 0 18px 40px rgba(24, 29, 45, 0.12);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Trebuchet MS", "Verdana", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #fff7e5 0%, #f0f3f8 45%, #e9eff4 100%);
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 28px 32px 16px;
        background: linear-gradient(120deg, #1f2a44, #2a6f7f 55%, #548687);
        color: #f9fbff;
        position: sticky;
        top: 0;
        z-index: 20;
        box-shadow: 0 6px 20px rgba(18, 25, 40, 0.2);
      }

      header h1 {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: 28px;
        margin: 0 0 6px;
        letter-spacing: 0.5px;
      }

      header p {
        margin: 0;
        opacity: 0.85;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.25);
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
      }

      .theme-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #fff;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 700;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #f1c04d;
      }

      .status-dot.ok {
        background: #5ee0b5;
      }

      .tabs {
        display: flex;
        gap: 12px;
        padding: 14px 32px 0;
        background: #f7f3ea;
        border-bottom: 1px solid #e2d6be;
      }

      .tab {
        border: none;
        background: #fff5df;
        padding: 10px 16px;
        border-radius: 12px 12px 6px 6px;
        font-weight: 700;
        color: #4b3b28;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .tab.active {
        background: #fffdf7;
        box-shadow: 0 6px 16px rgba(31, 42, 68, 0.1);
        border-bottom: 3px solid #e07a2d;
      }

      main {
        padding: 24px 32px 40px;
        flex: 1;
      }

      .tab-panel {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .tab-panel.active {
        display: block;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(280px, 1fr) minmax(320px, 1.9fr);
        gap: 20px;
      }

      .card {
        background: var(--cream);
        border: 1px solid var(--sand-deep);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .card h2 {
        margin-top: 0;
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: 20px;
      }

      .panel {
        border: 1px solid #dccfb8;
        background: #fff7e8;
        border-radius: 12px;
        padding: 12px;
        min-height: 180px;
        font-family: "Cascadia Code", "Consolas", "Courier New", monospace;
        font-size: 13px;
        overflow: auto;
      }

      .panel ul {
        margin: 6px 0 0 18px;
        padding: 0;
      }

      .panel li {
        margin-bottom: 6px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        border: 1px solid #dccfb8;
        border-radius: 12px;
        padding: 12px;
        font-family: "Cascadia Code", "Consolas", "Courier New", monospace;
        font-size: 13px;
        background: #fff;
        resize: vertical;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }

      button {
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: 700;
        background: var(--ink);
        color: #fff;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(31, 42, 68, 0.18);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .ghost {
        background: #fff5df;
        color: #4b3b28;
        border: 1px solid #e1d4b8;
      }

      .status {
        margin-top: 10px;
        font-weight: 700;
        color: var(--ink);
      }

      .status.error {
        color: #c0392b;
      }

      .promptDisplay {
        margin-top: 14px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f1e6d1;
        font-size: 13px;
      }

      .label {
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 6px;
        color: var(--ink-soft);
      }

      iframe {
        width: 100%;
        min-height: 320px;
        border: 1px solid #dccfb8;
        border-radius: 12px;
        background: #fff;
      }

      .runs-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 20px;
      }

      .runs-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .run-item {
        text-align: left;
        background: #fff;
        border: 1px solid #eadcc6;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        font-family: "Trebuchet MS", "Verdana", sans-serif;
      }

      .run-item:hover {
        border-color: #d1b48a;
        box-shadow: 0 8px 18px rgba(31, 42, 68, 0.12);
      }

      .run-title {
        font-weight: 700;
        margin-bottom: 6px;
      }

      .run-snippet {
        font-size: 12px;
        color: #5b4d38;
      }

      .run-meta {
        font-size: 13px;
        margin-bottom: 12px;
        color: #3c2f1a;
      }

      .empty {
        padding: 14px;
        border-radius: 12px;
        border: 1px dashed #dcc9a8;
        background: #fff;
        color: #8a7b66;
      }

      body.dark {
        color: #f0f4ff;
        background: radial-gradient(circle at top left, #1c2436 0%, #0f141f 60%, #0b0f16 100%);
      }

      body.dark header {
        background: linear-gradient(120deg, #0f182a, #1b3842 55%, #295157);
      }

      body.dark .tabs {
        background: #121825;
        border-bottom-color: #2b364f;
      }

      body.dark .tab {
        background: #1a2234;
        color: #c9d5ef;
        border-color: #2b364f;
      }

      body.dark .tab.active {
        background: #1f2a44;
        border-bottom-color: #3aa486;
      }

      body.dark .card {
        background: #141b2b;
        border-color: #2b364f;
      }

      body.dark .panel,
      body.dark textarea {
        background: #101626;
        border-color: #2b364f;
        color: #d9e3ff;
      }

      body.dark .promptDisplay {
        background: #1a2336;
        color: #d1dcf7;
      }

      body.dark .run-item {
        background: #111826;
        border-color: #2b364f;
        color: #d1dcf7;
      }

      body.dark .run-snippet {
        color: #99a8c7;
      }

      body.dark .empty {
        background: #0f1522;
        border-color: #2b364f;
        color: #99a8c7;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @media (max-width: 980px) {
        .layout,
        .runs-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 720px) {
        header {
          padding: 22px 20px 14px;
        }
        .tabs,
        main {
          padding-left: 20px;
          padding-right: 20px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-row">
        <div>
          <h1>Local LLM Web Pipeline</h1>
          <p>Plan, generate, and preview sandboxed HTML with local models.</p>
        </div>
        <div class="actions" style="margin: 0;">
          <div class="status-pill">
            <span id="healthDot" class="status-dot"></span>
            <span id="healthText">Checking server...</span>
          </div>
          <button id="themeToggle" class="theme-toggle" type="button">Dark mode</button>
        </div>
      </div>
    </header>

    <nav class="tabs" aria-label="Main tabs">
      <button class="tab active" data-tab="create">Create New</button>
      <button class="tab" data-tab="runs">Saved Programs</button>
    </nav>

    <main>
      <section class="tab-panel active" id="tab-create">
        <div class="layout">
          <section class="card">
            <h2>Prompt</h2>
            <textarea id="promptInput" placeholder="Describe the web page you want..."></textarea>
            <div class="actions">
              <button id="generateBtn">Generate</button>
              <button id="copyBtn" disabled>Copy HTML</button>
              <button id="downloadBtn" disabled>Download HTML</button>
            </div>
            <div id="status" class="status">Idle</div>
            <div class="promptDisplay">
              <div class="label">Last prompt</div>
              <div id="promptDisplay">None yet</div>
            </div>
          </section>

          <section class="card">
            <h2>Plan (JSON)</h2>
            <div id="planOutput" class="panel">Waiting for plan...</div>
          </section>

          <section class="card">
            <h2>Generated HTML</h2>
            <textarea id="htmlOutput" class="panel" readonly></textarea>
          </section>

          <section class="card">
            <h2>Preview (sandboxed iframe)</h2>
            <iframe id="previewFrame" sandbox="allow-scripts allow-forms" title="Preview"></iframe>
          </section>
        </div>
      </section>

      <section class="tab-panel" id="tab-runs">
        <div class="runs-grid">
          <section class="card">
            <div class="label" style="font-size: 14px;">Saved programs</div>
            <div class="actions" style="margin: 8px 0 12px;">
              <button id="refreshRunsBtn" class="ghost">Refresh</button>
            </div>
            <div id="runsList" class="runs-list">
              <div class="empty">No runs yet. Create one to see it here.</div>
            </div>
          </section>

          <section class="card">
            <div class="label" style="font-size: 14px;">Run details</div>
            <div class="actions" style="margin: 8px 0 12px;">
              <button id="runCopyBtn" disabled>Copy HTML</button>
              <button id="runDownloadBtn" disabled>Download HTML</button>
            </div>
            <div id="runMeta" class="run-meta">Select a run to view details.</div>
            <div class="label">Prompt</div>
            <pre id="runPrompt" class="panel">-</pre>
            <div class="label" style="margin-top: 16px;">Plan (JSON)</div>
            <div id="runPlan" class="panel">-</div>
            <div class="label" style="margin-top: 16px;">HTML</div>
            <textarea id="runHtml" class="panel" readonly></textarea>
            <div class="label" style="margin-top: 16px;">Preview</div>
            <iframe id="runPreview" sandbox="allow-scripts allow-forms" title="Run preview"></iframe>
          </section>
        </div>
      </section>
    </main>

    <script>
      const statusEl = document.getElementById("status");
      const promptInput = document.getElementById("promptInput");
      const promptDisplay = document.getElementById("promptDisplay");
      const planOutput = document.getElementById("planOutput");
      const htmlOutput = document.getElementById("htmlOutput");
      const previewFrame = document.getElementById("previewFrame");
      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const healthDot = document.getElementById("healthDot");
      const healthText = document.getElementById("healthText");
      const themeToggle = document.getElementById("themeToggle");
      const tabs = document.querySelectorAll(".tab");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const runsList = document.getElementById("runsList");
      const refreshRunsBtn = document.getElementById("refreshRunsBtn");
      const runMeta = document.getElementById("runMeta");
      const runPrompt = document.getElementById("runPrompt");
      const runPlan = document.getElementById("runPlan");
      const runHtml = document.getElementById("runHtml");
      const runPreview = document.getElementById("runPreview");
      const runCopyBtn = document.getElementById("runCopyBtn");
      const runDownloadBtn = document.getElementById("runDownloadBtn");

      let latestHtml = "";
      let latestRunHtml = "";

      function formatValue(value) {
        if (Array.isArray(value)) return value.map(String);
        if (value && typeof value === "object") {
          return Object.entries(value).map(([key, val]) => `${key}: ${String(val)}`);
        }
        return [String(value)];
      }

      function planToHtml(plan) {
        if (!plan || typeof plan !== "object") return "<div class=\"empty\">No plan available.</div>";
        const sections = [];
        const preferredOrder = [
          "title",
          "description",
          "pages",
          "ui_components",
          "state",
          "interactions",
          "acceptance_criteria",
        ];
        const keys = [...preferredOrder, ...Object.keys(plan).filter((k) => !preferredOrder.includes(k))];

        keys.forEach((key) => {
          if (!(key in plan)) return;
          const value = plan[key];
          const label = key.replace(/_/g, " ");
          const lines = formatValue(value);
          const items = lines.map((line) => `<li>${line}</li>`).join("");
          sections.push(`<div class=\"label\">${label}</div><ul>${items}</ul>`);
        });

        return sections.join("");
      }

      function setStatus(text, isError) {
        statusEl.textContent = text;
        statusEl.classList.toggle("error", Boolean(isError));
      }

      async function checkHealth() {
        try {
          const res = await fetch("/api/health");
          if (!res.ok) throw new Error("Bad response");
          healthDot.classList.add("ok");
          healthText.textContent = "Server online";
        } catch (err) {
          healthDot.classList.remove("ok");
          healthText.textContent = "Server offline";
        }
      }

      function updatePreview(html) {
        previewFrame.srcdoc = html;
      }

      function setButtonsEnabled(enabled) {
        copyBtn.disabled = !enabled;
        downloadBtn.disabled = !enabled;
      }

      function setRunButtonsEnabled(enabled) {
        runCopyBtn.disabled = !enabled;
        runDownloadBtn.disabled = !enabled;
      }

      function setActiveTab(tabName) {
        tabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle("active", panel.id === `tab-${tabName}`);
        });
      }

      async function loadRuns() {
        runsList.innerHTML = "<div class=\"empty\">Loading runs...</div>";
        try {
          const res = await fetch("/api/runs");
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to load runs");

          if (!data.runs || data.runs.length === 0) {
            runsList.innerHTML = "<div class=\"empty\">No runs yet. Create one to see it here.</div>";
            return;
          }

          runsList.innerHTML = "";
          data.runs.forEach((run) => {
            const button = document.createElement("button");
            button.className = "run-item";
            button.type = "button";
            button.innerHTML = `
              <div class=\"run-title\">${run.timestamp}</div>
              <div class=\"run-snippet\">${run.prompt_preview || "No prompt saved."}</div>
            `;
            button.addEventListener("click", () => loadRunDetails(run.timestamp));
            runsList.appendChild(button);
          });
        } catch (err) {
          runsList.innerHTML = `<div class=\"empty\">${err.message || "Failed to load runs."}</div>`;
        }
      }

      async function loadRunDetails(timestamp) {
        runMeta.textContent = "Loading run details...";
        runPrompt.textContent = "-";
        runPlan.innerHTML = "-";
        runHtml.value = "";
        runPreview.srcdoc = "<html><body></body></html>";
        setRunButtonsEnabled(false);

        try {
          const res = await fetch(`/api/run/${timestamp}`);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to load run");

          const meta = data.meta || {};
          const models = meta.models ? `Planner: ${meta.models.planner}, Coder: ${meta.models.coder}` : "Models: -";
          const durations = meta.durations_ms
            ? `Durations (ms) - planner: ${meta.durations_ms.planner}, coder: ${meta.durations_ms.coder}, total: ${meta.durations_ms.total}`
            : "Durations: -";

        runMeta.textContent = `${data.timestamp} | ${models} | ${durations}`;
        runPrompt.textContent = data.prompt || "-";
        runPlan.innerHTML = planToHtml(data.plan);
        latestRunHtml = data.html || "";
        runHtml.value = latestRunHtml;
        runPreview.srcdoc = latestRunHtml;
        setRunButtonsEnabled(Boolean(latestRunHtml));
        } catch (err) {
          runMeta.textContent = err.message || "Failed to load run.";
        }
      }

      async function generatePipeline() {
        const prompt = promptInput.value.trim();
        if (!prompt) {
          setStatus("Please enter a prompt.", true);
          return;
        }

        promptDisplay.textContent = prompt;
        planOutput.textContent = "";
        htmlOutput.value = "";
        updatePreview("<html><body></body></html>");
        setButtonsEnabled(false);

        try {
          setStatus("Planning...", false);
          const planStart = performance.now();
          const planRes = await fetch("/api/plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });

          const planData = await planRes.json();
          if (!planRes.ok) throw new Error(planData.error || "Plan failed");

        planOutput.innerHTML = planToHtml(planData.plan);
        const planMs = Math.round(performance.now() - planStart);

          setStatus("Coding...", false);
          const genRes = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, plan: planData.plan, plan_ms: planMs, save: true }),
          });

          const genData = await genRes.json();
          if (!genRes.ok) throw new Error(genData.error || "Generation failed");

          latestHtml = genData.html || "";
          htmlOutput.value = latestHtml;
          updatePreview(latestHtml);
          setButtonsEnabled(Boolean(latestHtml));
          setStatus("Done", false);
          if (genData.timestamp) loadRuns();
        } catch (err) {
          setStatus(err.message || "Something went wrong", true);
        }
      }

      copyBtn.addEventListener("click", async () => {
        if (!latestHtml) return;
        try {
          await navigator.clipboard.writeText(latestHtml);
          setStatus("HTML copied to clipboard.", false);
        } catch (err) {
          setStatus("Copy failed. Try manually selecting the text.", true);
        }
      });

      downloadBtn.addEventListener("click", () => {
        if (!latestHtml) return;
        const blob = new Blob([latestHtml], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "generated.html";
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      });

      runCopyBtn.addEventListener("click", async () => {
        if (!latestRunHtml) return;
        try {
          await navigator.clipboard.writeText(latestRunHtml);
          runMeta.textContent = "HTML copied to clipboard.";
        } catch (err) {
          runMeta.textContent = "Copy failed. Try manually selecting the text.";
        }
      });

      runDownloadBtn.addEventListener("click", () => {
        if (!latestRunHtml) return;
        const blob = new Blob([latestRunHtml], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "generated.html";
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      });

      generateBtn.addEventListener("click", generatePipeline);
      refreshRunsBtn.addEventListener("click", loadRuns);

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          setActiveTab(tab.dataset.tab);
          if (tab.dataset.tab === "runs") loadRuns();
        });
      });

      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        themeToggle.textContent = isDark ? "Light mode" : "Dark mode";
        localStorage.setItem("llm_pipeline_theme", isDark ? "dark" : "light");
      });

      const savedTheme = localStorage.getItem("llm_pipeline_theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark");
        themeToggle.textContent = "Light mode";
      }

      checkHealth();
      loadRuns();
    </script>
  </body>
</html>
