<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GE Appliances 9-to-5 Timesheet Review & Evaluation Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        :root {
            --ge-blue: #005CB9;
            --ge-blue-dark: #004a94;
            --ge-slate: #6D6E71;
            --ge-slate-light: #B1B3B3;
            --ge-bg: #f8f9fa;
        }
        
        .dark {
            --ge-bg: #1a1a1a;
        }
        
        .high-contrast {
            --ge-blue: #000080;
            --ge-slate: #000;
            --ge-slate-light: #333;
        }
        
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--ge-bg);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .table-sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .dark .table-sticky-header {
            background: #1a1a1a;
        }
        
        .high-contrast .table-sticky-header {
            background: #000;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        @media (max-width: 480px) {
            .chart-container {
                height: 250px;
            }
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-open .accordion-content {
            max-height: 400px;
        }
        
        .focus-ring:focus {
            outline: 2px solid var(--ge-blue);
            outline-offset: 2px;
        }
        
        .error-pattern {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 0, 0, 0.1) 10px,
                rgba(255, 0, 0, 0.1) 20px
            );
        }
        
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">GE Appliances Timesheet Dashboard</h1>
            <div class="flex gap-4">
                <button id="nav-dashboard" class="px-4 py-2 text-gray-600 hover:text-gray-900 focus-ring rounded">Dashboard</button>
                <button id="nav-details" class="px-4 py-2 text-gray-600 hover:text-gray-900 focus-ring rounded">Details</button>
                <button id="nav-reports" class="px-4 py-2 text-gray-600 hover:text-gray-900 focus-ring rounded">Reports</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Landing Page -->
        <section id="landing-page" class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Upload Timesheet for Review</h2>
                <p class="text-gray-600 mb-6">Select a CSV file to begin the review process</p>
                
                <div class="mb-6">
                    <input type="file" id="file-input" accept=".csv" class="hidden">
                    <button id="upload-btn" class="bg-[#005CB9] text-white px-8 py-4 rounded-lg font-semibold hover:bg-[#004a94] transition-colors focus-ring inline-flex items-center gap-2">
                        <span class="material-symbols-outlined">upload_file</span>
                        Upload Timesheet
                    </button>
                </div>

                <div id="progress-container" class="hidden mb-4">
                    <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div id="progress-bar" class="progress-bar bg-[#005CB9] h-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="mt-2 text-sm text-gray-600" aria-live="polite">Processing...</p>
                </div>

                <div id="error-container" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-red-600">error</span>
                        <div class="flex-1">
                            <h3 class="font-semibold text-red-800 mb-2">Validation Errors</h3>
                            <ul id="error-list" class="list-disc list-inside text-red-700 text-sm"></ul>
                            <button id="download-errors" class="mt-3 text-red-600 hover:text-red-800 underline text-sm">
                                Download error log
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="raw-data-section" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Raw Timesheet Data</h3>
                        <div class="flex items-center gap-4">
                            <input type="text" id="global-search" placeholder="Search..." class="px-3 py-2 border border-gray-300 rounded focus-ring">
                            <select id="page-size" class="px-3 py-2 border border-gray-300 rounded focus-ring">
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="raw-table" class="w-full">
                            <thead class="table-sticky-header">
                                <tr class="border-b">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50" data-column="employee_id">
                                        Employee ID <span class="sort-icon">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50" data-column="name">
                                        Name <span class="sort-icon">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50" data-column="date">
                                        Date <span class="sort-icon">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50" data-column="clock_in">
                                        Clock In <span class="sort-icon">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50" data-column="clock_out">
                                        Clock Out <span class="sort-icon">↕</span>
                                    </th>
                                </tr>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2"><input type="text" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring" placeholder="Filter ID"></th>
                                    <th class="px-4 py-2"><input type="text" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring" placeholder="Filter Name"></th>
                                    <th class="px-4 py-2"><input type="date" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring"></th>
                                    <th class="px-4 py-2"><input type="time" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring"></th>
                                    <th class="px-4 py-2"><input type="time" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring"></th>
                                </tr>
                            </thead>
                            <tbody id="raw-table-body"></tbody>
                        </table>
                    </div>

                    <div id="pagination" class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600">
                            Showing <span id="showing-from">1</span> to <span id="showing-to">25</span> of <span id="total-rows">0</span> entries
                        </div>
                        <div class="flex gap-2">
                            <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 focus-ring">Previous</button>
                            <span id="page-info" class="px-3 py-1">Page 1 of 1</span>
                            <button id="next-page" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 focus-ring">Next</button>
                        </div>
                    </div>

                    <div class="mt-6 flex items-center justify-between">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="review-checkbox" class="rounded focus-ring">
                            <span class="text-sm text-gray-700">I have reviewed the data</span>
                        </label>
                        <button id="analyse-btn" disabled class="bg-gray-400 text-white px-6 py-2 rounded font-semibold cursor-not-allowed">
                            Analyse Data
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="dashboard-page" class="hidden">
            <div class="mb-8">
                <button id="back-to-raw" class="text-[#005CB9] hover:text-[#004a94] mb-4 inline-flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">arrow_back</span>
                    Back to raw data
                </button>
                
                <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Total Employees</h3>
                        <p id="kpi-total-employees" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Average Hours</h3>
                        <p id="kpi-avg-hours" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Total Overtime</h3>
                        <p id="kpi-overtime" class="text-3xl font-bold text-red-600">-</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Avg Punctuality</h3>
                        <p id="kpi-punctuality" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Employee Performance Summary</h3>
                    <div class="overflow-x-auto">
                        <table id="summary-table" class="w-full">
                            <thead class="table-sticky-header">
                                <tr class="border-b">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Employee</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Total Hours</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Avg Daily Hours</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Days Worked</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Punctuality</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Overtime</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Employee Hours Ranking</h3>
                        <div id="hours-chart-accordion" class="accordion-open lg:hidden">
                            <button class="accordion-toggle w-full text-left font-medium text-gray-700 mb-2">Show Chart</button>
                            <div class="accordion-content">
                                <div class="chart-container">
                                    <canvas id="hours-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="hidden lg:block">
                            <div class="chart-container">
                                <canvas id="hours-chart-desktop"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Daily Workforce Totals</h3>
                        <div id="daily-chart-accordion" class="accordion-open lg:hidden">
                            <button class="accordion-toggle w-full text-left font-medium text-gray-700 mb-2">Show Chart</button>
                            <div class="accordion-content">
                                <div class="chart-container">
                                    <canvas id="daily-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="hidden lg:block">
                            <div class="chart-container">
                                <canvas id="daily-chart-desktop"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Page -->
        <section id="reports-page" class="hidden print:max-w-none print:p-0">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 print:hidden">
                    <h2 class="text-2xl font-bold text-gray-800">Employee Reports</h2>
                    <button id="print-all" class="bg-[#005CB9] text-white px-4 py-2 rounded hover:bg-[#004a94] focus-ring">
                        Print All Reports
                    </button>
                </div>
                <div id="reports-container"></div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-100 mt-12 py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex gap-4">
                <button id="theme-toggle" class="text-sm text-gray-600 hover:text-gray-900 focus-ring px-3 py-1 rounded">
                    Toggle Theme
                </button>
                <button id="contrast-toggle" class="text-sm text-gray-600 hover:text-gray-900 focus-ring px-3 py-1 rounded">
                    High Contrast
                </button>
                <button id="lang-toggle" class="text-sm text-gray-600 hover:text-gray-900 focus-ring px-3 py-1 rounded">
                    ES/EN
                </button>
            </div>
            <button id="help-toggle" class="text-sm text-gray-600 hover:text-gray-900 focus-ring px-3 py-1 rounded">
                Keyboard Shortcuts
            </button>
        </div>
    </footer>

    <!-- Help Panel -->
    <div id="help-panel" class="fixed right-0 top-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform z-50">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Keyboard Shortcuts</h3>
                <button id="close-help" class="text-gray-500 hover:text-gray-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-2 text-sm">
                <div><kbd class="bg-gray-100 px-2 py-1 rounded">U</kbd> - Upload file</div>
                <div><kbd class="bg-gray-100 px-2 py-1 rounded">R</kbd> - Go to Reports</div>
                <div><kbd class="bg-gray-100 px-2 py-1 rounded">/</kbd> - Search</div>
                <div><kbd class="bg-gray-100 px-2 py-1 rounded">?</kbd> - Toggle help</div>
            </div>
            <div class="mt-6">
                <h4 class="font-medium mb-2">Language</h4>
                <p class="text-sm text-gray-600">Press <kbd class="bg-gray-100 px-2 py-1 rounded">L</kbd> to toggle between English and Spanish</p>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            rawRows: [],
            filteredRows: [],
            csvData: [],
            employees: [],
            kpis: {},
            errors: [],
            pageSize: 25,
            currentPage: 1,
            searchTerm: '',
            filters: {},
            reviewed: false,
            theme: 'light',
            lang: 'en',
            charts: {}
        };

        // DOM elements
        const elements = {
            fileInput: document.getElementById('file-input'),
            uploadBtn: document.getElementById('upload-btn'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            errorContainer: document.getElementById('error-container'),
            errorList: document.getElementById('error-list'),
            downloadErrors: document.getElementById('download-errors'),
            rawDataSection: document.getElementById('raw-data-section'),
            rawTableBody: document.getElementById('raw-table-body'),
            globalSearch: document.getElementById('global-search'),
            pageSize: document.getElementById('page-size'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            showingFrom: document.getElementById('showing-from'),
            showingTo: document.getElementById('showing-to'),
            totalRows: document.getElementById('total-rows'),
            pageInfo: document.getElementById('page-info'),
            reviewCheckbox: document.getElementById('review-checkbox'),
            analyseBtn: document.getElementById('analyse-btn'),
            landingPage: document.getElementById('landing-page'),
            dashboardPage: document.getElementById('dashboard-page'),
            reportsPage: document.getElementById('reports-page'),
            backToRaw: document.getElementById('back-to-raw'),
            helpPanel: document.getElementById('help-panel'),
            helpToggle: document.getElementById('help-toggle'),
            closeHelp: document.getElementById('close-help'),
            themeToggle: document.getElementById('theme-toggle'),
            contrastToggle: document.getElementById('contrast-toggle'),
            langToggle: document.getElementById('lang-toggle')
        };

        // Translations
        const translations = {
            en: {
                upload: 'Upload Timesheet',
                processing: 'Processing...',
                reviewData: 'I have reviewed the data',
                analyse: 'Analyse Data',
                totalEmployees: 'Total Employees',
                avgHours: 'Average Hours',
                totalOvertime: 'Total Overtime',
                avgPunctuality: 'Avg Punctuality',
                employee: 'Employee',
                totalHours: 'Total Hours',
                avgDailyHours: 'Avg Daily Hours',
                daysWorked: 'Days Worked',
                punctuality: 'Punctuality',
                overtime: 'Overtime',
                hoursRanking: 'Employee Hours Ranking',
                dailyTotals: 'Daily Workforce Totals'
            },
            es: {
                upload: 'Cargar Hoja de Tiempo',
                processing: 'Procesando...',
                reviewData: 'He revisado los datos',
                analyse: 'Analizar Datos',
                totalEmployees: 'Total Empleados',
                avgHours: 'Promedio Horas',
                totalOvertime: 'Total Horas Extra',
                avgPunctuality: 'Promedio Puntualidad',
                employee: 'Empleado',
                totalHours: 'Total Horas',
                avgDailyHours: 'Promedio Diario',
                daysWorked: 'Días Trabajados',
                punctuality: 'Puntualidad',
                overtime: 'Horas Extra',
                hoursRanking: 'Ranking de Horas',
                dailyTotals: 'Totales Diarios'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            applyTheme();
        });

        function setupEventListeners() {
            elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileUpload);
            elements.reviewCheckbox.addEventListener('change', toggleAnalyseButton);
            elements.analyseBtn.addEventListener('click', handleAnalyse);
            elements.backToRaw.addEventListener('click', showLandingPage);
            elements.helpToggle.addEventListener('click', toggleHelp);
            elements.closeHelp.addEventListener('click', toggleHelp);
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.contrastToggle.addEventListener('click', toggleContrast);
            elements.langToggle.addEventListener('click', toggleLanguage);
            elements.downloadErrors.addEventListener('click', downloadErrorLog);
            
            // Table interactions
            elements.globalSearch.addEventListener('input', debounce(handleSearch, 300));
            elements.pageSize.addEventListener('change', handlePageSizeChange);
            elements.prevPage.addEventListener('click', () => changePage(-1));
            elements.nextPage.addEventListener('click', () => changePage(1));
            
            // Navigation
            document.getElementById('nav-dashboard').addEventListener('click', showDashboardPage);
            document.getElementById('nav-details').addEventListener('click', showDashboardPage);
            document.getElementById('nav-reports').addEventListener('click', showReportsPage);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showProgress();
            resetState();
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    hideProgress();
                    
                    if (results.errors.length > 0) {
                        showErrors(results.errors);
                        return;
                    }
                    
                    const { data, errors } = validateData(results.data);
                    
                    if (errors.length > 0) {
                        showErrors(errors);
                        return;
                    }
                    
                    state.csvData = data;
                    state.rawRows = [...data];
                    state.filteredRows = [...data];
                    showRawData();
                },
                error: (error) => {
                    hideProgress();
                    showErrors([{ message: error.message }]);
                }
            });
        }

        function validateData(data) {
            const errors = [];
            const validated = [];
            const seen = new Set();
            
            const requiredColumns = ['employee_id', 'name', 'date', 'clock_in', 'clock_out'];
            
            data.forEach((row, index) => {
                const missing = requiredColumns.filter(col => !row[col] || !row[col].trim());
                
                if (missing.length > 0) {
                    errors.push({
                        row: index + 1,
                        message: `Missing required columns: ${missing.join(', ')}`
                    });
                    return;
                }
                
                const key = `${row.employee_id}|${row.date}`;
                if (seen.has(key)) {
                    errors.push({
                        row: index + 1,
                        message: `Duplicate entry for employee ${row.employee_id} on ${row.date}`
                    });
                    return;
                }
                
                seen.add(key);
                validated.push(row);
            });
            
            return { data: validated, errors };
        }

        function showProgress() {
            elements.progressContainer.classList.remove('hidden');
            elements.progressBar.style.width = '0%';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                elements.progressBar.style.width = `${Math.min(progress, 90)}%`;
                
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 200);
        }

        function hideProgress() {
            elements.progressBar.style.width = '100%';
            setTimeout(() => {
                elements.progressContainer.classList.add('hidden');
            }, 500);
        }

        function showErrors(errors) {
            state.errors = errors;
            elements.errorContainer.classList.remove('hidden');
            elements.errorList.innerHTML = errors.map(err => 
                `<li>Row ${err.row}: ${err.message}</li>`
            ).join('');
        }

        function downloadErrorLog() {
            const content = state.errors.map(err => `Row ${err.row}: ${err.message}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'errors.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function showRawData() {
            elements.rawDataSection.classList.remove('hidden');
            renderRawTable();
        }

        function renderRawTable() {
            const start = (state.currentPage - 1) * (state.pageSize === 'all' ? state.filteredRows.length : state.pageSize);
            const end = state.pageSize === 'all' ? state.filteredRows.length : start + state.pageSize;
            const pageData = state.filteredRows.slice(start, end);
            
            elements.rawTableBody.innerHTML = pageData.map(row => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${row.employee_id}</td>
                    <td class="px-4 py-3 text-sm">${row.name}</td>
                    <td class="px-4 py-3 text-sm">${row.date}</td>
                    <td class="px-4 py-3 text-sm">${row.clock_in}</td>
                    <td class="px-4 py-3 text-sm">${row.clock_out}</td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        function updatePagination() {
            const total = state.filteredRows.length;
            const pageSize = state.pageSize === 'all' ? total : state.pageSize;
            const totalPages = Math.ceil(total / pageSize);
            
            elements.showingFrom.textContent = (state.currentPage - 1) * pageSize + 1;
            elements.showingTo.textContent = Math.min(state.currentPage * pageSize, total);
            elements.totalRows.textContent = total;
            elements.pageInfo.textContent = `Page ${state.currentPage} of ${totalPages}`;
            
            elements.prevPage.disabled = state.currentPage === 1;
            elements.nextPage.disabled = state.currentPage === totalPages;
        }

        function handleSearch(e) {
            state.searchTerm = e.target.value.toLowerCase();
            applyFilters();
        }

        function applyFilters() {
            state.filteredRows = state.rawRows.filter(row => {
                const matchesSearch = !state.searchTerm || 
                    Object.values(row).some(val => 
                        val.toString().toLowerCase().includes(state.searchTerm)
                    );
                
                return matchesSearch;
            });
            
            state.currentPage = 1;
            renderRawTable();
        }

        function changePage(direction) {
            const total = state.filteredRows.length;
            const pageSize = state.pageSize === 'all' ? total : state.pageSize;
            const totalPages = Math.ceil(total / pageSize);
            
            const newPage = state.currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderRawTable();
            }
        }

        function handlePageSizeChange(e) {
            state.pageSize = e.target.value;
            state.currentPage = 1;
            renderRawTable();
        }

        function toggleAnalyseButton() {
            state.reviewed = elements.reviewCheckbox.checked;
            elements.analyseBtn.disabled = !state.reviewed;
            elements.analyseBtn.classList.toggle('bg-gray-400', !state.reviewed);
            elements.analyseBtn.classList.toggle('bg-[#005CB9]', state.reviewed);
            elements.analyseBtn.classList.toggle('cursor-not-allowed', !state.reviewed);
            elements.analyseBtn.classList.toggle('hover:bg-[#004a94]', state.reviewed);
        }

        function handleAnalyse() {
            calculateMetrics();
            showDashboardPage();
            renderKPIs();
            renderSummaryTable();
            renderCharts();
        }

        function calculateMetrics() {
            const employees = {};
            
            state.csvData.forEach(row => {
                const { employee_id, name, date, clock_in, clock_out } = row;
                const workStart = dayjs(`${date} ${clock_in}`);
                const workEnd = dayjs(`${date} ${clock_out}`);
                const hours = workEnd.diff(workStart, 'hour', true);
                
                if (!employees[employee_id]) {
                    employees[employee_id] = {
                        id: employee_id,
                        name,
                        totalHours: 0,
                        daysWorked: 0,
                        punctualDays: 0,
                        overtimeDays: 0,
                        entries: []
                    };
                }
                
                employees[employee_id].totalHours += hours;
                employees[employee_id].daysWorked++;
                employees[employee_id].entries.push(row);
                
                // Check punctuality (clock in by 09:05 for 09:00 start)
                const clockInTime = dayjs(`${date} ${clock_in}`);
                const startTime = dayjs(`${date} 09:00`);
                const diff = clockInTime.diff(startTime, 'minute');
                if (diff <= 5) employees[employee_id].punctualDays++;
                
                // Check overtime (>8 hours)
                if (hours > 8) employees[employee_id].overtimeDays++;
            });
            
            // Calculate averages and scores
            Object.values(employees).forEach(emp => {
                emp.avgDailyHours = emp.totalHours / emp.daysWorked;
                emp.punctualityScore = (emp.punctualDays / emp.daysWorked) * 100;
            });
            
            state.employees = Object.values(employees);
            
            // Calculate KPIs
            state.kpis = {
                totalEmployees: state.employees.length,
                avgHours: state.employees.reduce((sum, emp) => sum + emp.avgDailyHours, 0) / state.employees.length,
                totalOvertime: state.employees.reduce((sum, emp) => sum + emp.overtimeDays, 0),
                avgPunctuality: state.employees.reduce((sum, emp) => sum + emp.punctualityScore, 0) / state.employees.length
            };
        }

        function renderKPIs() {
            document.getElementById('kpi-total-employees').textContent = state.kpis.totalEmployees;
            document.getElementById('kpi-avg-hours').textContent = state.kpis.avgHours.toFixed(1);
            document.getElementById('kpi-overtime').textContent = Math.round(state.kpis.totalOvertime);
            document.getElementById('kpi-punctuality').textContent = `${state.kpis.avgPunctuality.toFixed(0)}%`;
        }

        function renderSummaryTable() {
            const tbody = document.getElementById('summary-table-body');
            tbody.innerHTML = state.employees.map(emp => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${emp.name}</div>
                        <div class="text-sm text-gray-500">${emp.id}</div>
                    </td>
                    <td class="px-4 py-3">${emp.totalHours.toFixed(1)}</td>
                    <td class="px-4 py-3">${emp.avgDailyHours.toFixed(1)}</td>
                    <td class="px-4 py-3">${emp.daysWorked}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded ${
                            emp.punctualityScore >= 90 ? 'bg-green-100 text-green-800' : 
                            emp.punctualityScore >= 70 ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-red-100 text-red-800'
                        }">${emp.punctualityScore.toFixed(0)}%</span>
                    </td>
                    <td class="px-4 py-3">
                        ${emp.overtimeDays > 0 ? 
                            `<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded">${emp.overtimeDays} days</span>` :
                            '<span class="text-gray-400">-</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        function renderCharts() {
            // Hours ranking chart
            const hoursCtx = document.getElementById('hours-chart-desktop').getContext('2d');
            state.charts.hours = new Chart(hoursCtx, {
                type: 'bar',
                data: {
                    labels: state.employees.slice(0, 8).map(emp => emp.name.split(' ')[0]),
                    datasets: [{
                        label: 'Total Hours',
                        data: state.employees.slice(0, 8).map(emp => emp.totalHours),
                        backgroundColor: '#005CB9',
                        borderColor: '#004a94',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 8 Employees by Hours'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
            
            // Daily totals chart
            const dailyTotals = {};
            state.csvData.forEach(row => {
                const date = row.date;
                const hours = dayjs(`${row.date} ${row.clock_out}`).diff(dayjs(`${row.date} ${row.clock_in}`), 'hour', true);
                dailyTotals[date] = (dailyTotals[date] || 0) + hours;
            });
            
            const dailyCtx = document.getElementById('daily-chart-desktop').getContext('2d');
            state.charts.daily = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyTotals).sort(),
<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "moonshotai/kimi-k2-instruct";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>