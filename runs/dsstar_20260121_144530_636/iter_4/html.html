<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com blob:; worker-src blob:; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org https://cdn.jsdelivr.net; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV Content Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
</head>
<body class="h-screen flex justify-center items-center">
  <div class="card bg-base-100 shadow-xl w-1/2">
    <div class="card-body">
      <h2 class="card-title">CSV Content Analyzer</h2>
      <p>Upload a CSV file to analyze its content</p>
      <input type="file" id="csv-file" accept=".csv" class="block mb-4">
      <button id="upload-btn" class="btn btn-primary">Upload</button>
      <div id="loading" class="hidden">
        <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <div id="summary" class="hidden">
        <h3 class="card-title">Summary</h3>
        <p id="ai-summary"></p>
        <div id="column-insights">
          <!-- column insights will be displayed here -->
        </div>
        <button id="download-btn" class="btn btn-secondary">Download Report</button>
      </div>
    </div>
  </div>
  <script>
    const fileInput = document.getElementById('csv-file');
    const uploadButton = document.getElementById('upload-btn');
    const loadingIndicator = document.getElementById('loading');
    const summaryContainer = document.getElementById('summary');
    const downloadButton = document.getElementById('download-btn');
    const aiSummaryElement = document.getElementById('ai-summary');
    const columnInsightsElement = document.getElementById('column-insights');

    let fileName;
    let rawData;
    let parsedRows;
    let aiSummary;
    let aiColumns;
    let isLoading = false;

    uploadButton.addEventListener('click', () => {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileName = file.name;
        Papa.parse(file, {
          header: true,
          complete: (results) => {
            rawData = results.data;
            parsedRows = results.data;
            analyzeData();
          },
          error: (error) => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to parse CSV file',
            });
          },
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Please select a CSV file',
        });
      }
    });

    function analyzeData() {
      isLoading = true;
      loadingIndicator.classList.remove('hidden');
      const data = JSON.stringify(parsedRows);
      window.geaRuntimeLLM(`Analyze this CSV data and identify its content: ${data}`)
        .then((response) => {
          aiSummary = response;
          aiSummaryElement.textContent = aiSummary;
          const columnInsights = [];
          // assuming the AI returns column insights in the format: "column_name: insight"
          const insights = aiSummary.split(',');
          insights.forEach((insight) => {
            const [columnName, columnInsight] = insight.split(':');
            columnInsights.push({
              name: columnName.trim(),
              insight: columnInsight.trim(),
            });
          });
          aiColumns = columnInsights;
          columnInsightsElement.innerHTML = '';
          columnInsights.forEach((insight) => {
            const chip = document.createElement('div');
            chip.classList.add('badge', 'badge-primary');
            chip.textContent = `${insight.name}: ${insight.insight}`;
            columnInsightsElement.appendChild(chip);
          });
          summaryContainer.classList.remove('hidden');
          isLoading = false;
          loadingIndicator.classList.add('hidden');
        })
        .catch((error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to analyze data',
          });
          isLoading = false;
          loadingIndicator.classList.add('hidden');
        });
    }

    downloadButton.addEventListener('click', () => {
      const doc = new jsPDF.jsPDF();
      doc.text('CSV Content Analyzer Report', 10, 10);
      doc.text(`File Name: ${fileName}`, 10, 20);
      doc.text(`AI Summary: ${aiSummary}`, 10, 30);
      doc.text('Column Insights:', 10, 40);
      aiColumns.forEach((insight, index) => {
        doc.text(`${insight.name}: ${insight.insight}`, 10, 50 + (index * 10));
      });
      doc.save(`csv-content-analyzer-report-${fileName}.pdf`);
    });
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window._geaRuntimeInjected) return;
  window._geaRuntimeInjected = true;
  
  const defaultModel = "llama-3.3-70b-versatile";
  const appId = "dsstar_20260121_144530_636";
  
  // AI Helper
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;

  // Data Store Helper
  window.geaRuntimeStore = {
    async get(key) {
      const response = await fetch('/api/runtime/store/' + encodeURIComponent(key), {
        headers: { 'X-App-ID': appId }
      });
      if (!response.ok) return null;
      return await response.json().catch(() => null);
    },
    async set(key, value) {
      const response = await fetch('/api/runtime/store/' + encodeURIComponent(key), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-App-ID': appId },
        body: JSON.stringify(value)
      });
      return response.ok;
    }
  };
})();
</script>
</body>
</html>