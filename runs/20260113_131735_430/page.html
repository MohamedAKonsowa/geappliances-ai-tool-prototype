<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org https://cdn.jsdelivr.net; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8">
  <title>GEA Punctuality Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --ge-primary:#007a8a;
      --ge-dark:#005f6b;
      --ge-accent:#f39200;
      --ge-red:#ff5f57;
      --base:16px;
    }
    body{font-size:var(--base);font-family:'Inter',sans-serif;}
    .focus-ge:focus-visible{outline:3px solid var(--ge-red);outline-offset:2px;}
    @media (prefers-reduced-motion:reduce){
      *{transition:none!important;animation:none!important;}
    }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body class="bg-white text-gray-900">
  <div id="app" class="min-h-screen flex flex-col">
    <header class="bg-gray-50 border-b border-gray-200 px-4 py-4">
      <h1 class="text-xl font-semibold text-gray-800">GEA Punctuality Dashboard</h1>
    </header>

    <!-- Landing -->
    <section id="landing" class="flex-1 p-4 grid place-content-center">
      <div id="dropzone" role="button" tabindex="0" aria-label="Upload Timesheet"
           class="w-full max-w-xl border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-ge-primary focus-ge">
        <span class="material-symbols-outlined text-4xl text-gray-400">upload</span>
        <p class="mt-2 text-gray-700">Drag & drop your two-week CSV here</p>
        <p class="text-sm text-gray-500 mt-1">or click to browse</p>
        <input id="csvInput" type="file" accept=".csv" class="sr-only">
      </div>
      <div id="errorBanner" class="hidden mt-4 p-3 rounded-lg bg-red-50 text-red-800"></div>
    </section>

    <!-- Processing -->
    <section id="processing" class="hidden flex-1 p-4 grid place-content-center">
      <p class="text-gray-700 mb-2">Processing your timesheetâ€¦</p>
      <progress id="progressBar" class="w-full h-3" value="0" max="100"></progress>
    </section>

    <!-- Results -->
    <section id="results" class="hidden flex-1 p-4 grid gap-6 md:grid-cols-2">
      <div id="bestCard" class="card bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-full bg-gray-200 grid place-content-center text-2xl">ðŸ‘¤</div>
          <div>
            <p id="bestName" class="font-semibold text-lg"></p>
            <span class="badge badge-success">Best Performer</span>
            <span id="bestScore" class="ml-2 badge badge-outline"></span>
          </div>
        </div>
        <p id="bestSummary" class="mt-3 text-sm text-gray-700"></p>
      </div>

      <div id="worstCard" class="card bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-full bg-gray-200 grid place-content-center text-2xl">ðŸ‘¤</div>
          <div>
            <p id="worstName" class="font-semibold text-lg"></p>
            <span class="badge badge-warning">Needs Improvement</span>
            <span id="worstScore" class="ml-2 badge badge-outline"></span>
          </div>
        </div>
        <p id="worstSummary" class="mt-3 text-sm text-gray-700"></p>
      </div>

      <div class="md:col-span-2">
        <canvas id="compareChart" aria-label="Comparison chart" role="img"></canvas>
      </div>

      <div class="md:col-span-2 overflow-x-auto">
        <table id="rankTable" class="table table-zebra w-full text-sm">
          <thead>
            <tr>
              <th aria-sort="none">Rank</th>
              <th>Name</th>
              <th>Punctuality In</th>
              <th>Punctuality Out</th>
              <th>Consistency</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Export -->
    <section id="export" class="hidden p-4 flex gap-2">
      <button id="downloadBtn" class="btn btn-primary">Download Report</button>
      <button id="newBtn" class="btn btn-outline">Upload New File</button>
    </section>
  </div>

  <script>
    const SHIFT_START='09:00',SHIFT_END='17:00',IDEAL=8*60;
    let employees=[],best=null,worst=null,compareChart=null;

    const $=id=>document.getElementById(id);
    const hide=id=>$(id).classList.add('hidden');
    const show=id=>$(id).classList.remove('hidden');

    const tz='America/New_York';
    const parseTime=(t,date)=>{
      const d=dayjs(date).format('YYYY-MM-DD');
      return dayjs(`${d}T${t}:00`,'YYYY-MM-DDTHH:mm:ss').valueOf();
    };
    const minsFrom=(base,t)=>{
      return Math.round((t-base)/60000);
    };

    const calcScore=(e)=>{
      const pIn=Math.max(0,100-e.avgLateIn);
      const pOut=Math.max(0,100-Math.abs(e.avgEarlyOut));
      const cons=Math.max(0,100-e.stdDev);
      return 0.4*pIn+0.3*pOut+0.3*cons;
    };

    const processCSV=text=>{
      const {data,errors}=Papa.parse(text,{header:true,skipEmptyLines:true});
      if(errors.length) throw new Error('Malformed CSV');
      const cols=new Set(Object.keys(data[0]||{}));
      const req=new Set(['employee_id','name','date','clock_in','clock_out']);
      for(const r of req) if(!cols.has(r)) throw new Error(`Missing column: ${r}`);
      const map={};
      data.forEach(r=>{
        const id=r.employee_id,name=r.name,date=r.date,inT=r.clock_in,outT=r.clock_out;
        if(!id||!name||!date||!inT||!outT) return;
        if(!map[id]) map[id]={id,name,records:[]};
        map[id].records.push({date,in:inT,out:outT});
      });
      employees=Object.values(map).map(e=>{
        const rec=e.records;
        let totIn=0,totOut=0,totLen=0,arr=[];
        rec.forEach(r=>{
          const start=parseTime(SHIFT_START,r.date);
          const end=parseTime(SHIFT_END,r.date);
          const inVal=parseTime(r.in,r.date);
          const outVal=parseTime(r.out,r.date);
          const lateIn=minsFrom(start,inVal);
          const earlyOut=minsFrom(outVal,end);
          const len=minsFrom(inVal,outVal);
          totIn+=lateIn;
          totOut+=earlyOut;
          totLen+=len;
          arr.push(len);
        });
        const n=rec.length;
        e.avgLateIn=totIn/n;
        e.avgEarlyOut=totOut/n;
        e.avgLen=totLen/n;
        e.stdDev=ss.standardDeviation(arr);
        e.score=calcScore(e);
        return e;
      });
      employees.sort((a,b)=>b.score-a.score);
      best=employees[0];
      worst=employees[employees.length-1];
    };

    const renderResults=async()=>{
      $('bestName').textContent=best.name;
      $('bestScore').textContent=Math.round(best.score);
      $('bestSummary').textContent=await window.geaRuntimeLLM(
        `Summarize in one plain sentence: ${best.name} averaged ${Math.round(best.avgLateIn)} min late to clock-in, ${Math.abs(Math.round(best.avgEarlyOut))} min ${best.avgEarlyOut<0?'late':'early'} to clock-out, and 8h ${Math.round(best.avgLen-IDEAL)} min shifts.`
      );
      $('worstName').textContent=worst.name;
      $('worstScore').textContent=Math.round(worst.score);
      $('worstSummary').textContent=await window.geaRuntimeLLM(
        `Summarize in one plain sentence: ${worst.name} averaged ${Math.round(worst.avgLateIn)} min late to clock-in, ${Math.abs(Math.round(worst.avgEarlyOut))} min ${worst.avgEarlyOut<0?'late':'early'} to clock-out, and 8h ${Math.round(worst.avgLen-IDEAL)} min shifts.`
      );
      drawCompare();
      fillTable();
    };

    const drawCompare=()=>{
      const ctx=$('compareChart').getContext('2d');
      compareChart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Punctuality In','Punctuality Out','Consistency'],
          datasets:[{
            label:best.name,
            data:[Math.max(0,100-best.avgLateIn),Math.max(0,100-Math.abs(best.avgEarlyOut)),Math.max(0,100-best.stdDev)],
            backgroundColor:'#007a8a'
          },{
            label:worst.name,
            data:[Math.max(0,100-worst.avgLateIn),Math.max(0,100-Math.abs(worst.avgEarlyOut)),Math.max(0,100-worst.stdDev)],
            backgroundColor:'#f39200'
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{position:'bottom'}},
          scales:{y:{beginAtZero:true,max:100}}
        }
      });
    };

    const fillTable=()=>{
      const tbody=$('rankTable').querySelector('tbody');
      tbody.innerHTML='';
      employees.forEach((e,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${i+1}</td>
          <td>${e.name}</td>
          <td>${Math.round(e.avgLateIn)} min</td>
          <td>${Math.round(e.avgEarlyOut)} min</td>
          <td>${Math.round(e.stdDev)}</td>
          <td>${Math.round(e.score)}</td>`;
        tr.className='focus-ge';
        tr.tabIndex=0;
        tr.addEventListener('click',()=>drawTimeline(e));
        tr.addEventListener('keydown',ev=>{if(ev.key==='Enter') drawTimeline(e);});
        tbody.appendChild(tr);
      });
    };

    const drawTimeline=(e)=>{
      const cont=document.createElement('div');cont.className='mt-4';
      const hd=document.createElement('h3');hd.className='text-md font-semibold';hd.textContent=`Daily timeline â€“ ${e.name}`;
      cont.appendChild(hd);
      const svg=d3.select(cont).append('svg').attr('height',200).attr('width','100%');
      const margin={top:20,right:20,bottom:40,left:40},
            width=600-margin.left-margin.right,
            height=200-margin.top-margin.bottom;
      const g=svg.append('g').attr('transform',`translate(${margin.left},${margin.top})`);
      const x=d3.scaleBand().range([0,width]).padding(0.1),
            y=d3.scaleLinear().range([height,0]);
      const data=e.records.map(r=>{
        const inVal=parseTime(r.in,r.date);
        const start=parseTime(SHIFT_START,r.date);
        return {date:r.date,delta:minsFrom(start,inVal)};
      });
      x.domain(data.map(d=>d.date));
      y.domain([d3.min(data,d=>d.delta-5),d3.max(data,d=>d.delta+5)]);
      g.append('g').attr('transform',`translate(0,${height})`).call(d3.axisBottom(x)).selectAll('text').style('text-anchor','end').attr('dx','-.8em').attr('dy','.15em').attr('transform','rotate(-45)');
      g.append('g').call(d3.axisLeft(y));
      g.selectAll('.bar').data(data).enter().append('rect')
        .attr('class','bar')
        .attr('x',d=>x(d.date))
        .attr('width',x.bandwidth())
        .attr('y',d=>y(d.delta))
        .attr('height',d=>height-y(d.delta))
        .attr('fill','#007a8a')
        .attr('tabindex',0)
        .attr('aria-label',d=>`${d.date}: ${Math.round(d.delta)} min late`);
      Swal.fire({title:'Daily Detail',html:cont,showConfirmButton:false});
    };

    const downloadPDF=()=>{
      const doc=new jspdf.jsPDF({orientation:'landscape'});
      doc.setFontSize(16);
      doc.text('GEA Punctuality Report',20,20);
      doc.setFontSize(12);
      doc.text(`Best: ${best.name} â€“ Score ${Math.round(best.score)}`,20,35);
      doc.text(`Worst: ${worst.name} â€“ Score ${Math.round(worst.score)}`,20,45);
      doc.text('Full ranking:',20,60);
      let y=70;
      employees.forEach((e,i)=>{
        doc.text(`${i+1}. ${e.name} â€“ ${Math.round(e.score)}`,25,y);
        y+=10;
      });
      doc.save('report.pdf');
    };

    const reset=()=>{
      employees=[];best=null;worst=null;
      $('csvInput').value='';
      hide('results');hide('export');hide('processing');hide('errorBanner');
      show('landing');
      if(compareChart){compareChart.destroy();compareChart=null;}
    };

    // Events
    $('dropzone').addEventListener('click',()=>$('csvInput').click());
    $('dropzone').addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' ') $('csvInput').click();
    });
    const dz=$('dropzone');
    ['dragenter','dragover'].forEach(ev=>{
      dz.addEventListener(ev,e=>{
        e.preventDefault();
        dz.classList.add('border-ge-primary');
      });
    });
    dz.addEventListener('dragleave',()=>dz.classList.remove('border-ge-primary'));
    dz.addEventListener('drop',e=>{
      e.preventDefault();
      dz.classList.remove('border-ge-primary');
      const f=e.dataTransfer.files[0];
      if(f&&f.type==='text/csv') handleFile(f);
    });
    $('csvInput').addEventListener('change',e=>handleFile(e.target.files[0]));
    $('downloadBtn').addEventListener('click',downloadPDF);
    $('newBtn').addEventListener('click',reset);

    const handleFile=file=>{
      if(!file||file.type!=='text/csv') return;
      hide('errorBanner');
      show('processing');hide('landing');
      const prog=$('progressBar');
      let val=0;
      const iv=setInterval(()=>{val+=5;prog.value=val;if(val>=90) clearInterval(iv);},100);
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          processCSV(reader.result);
          prog.value=100;
          hide('processing');
          renderResults().then(()=>{
            show('results');show('export');
          });
        }catch(err){
          clearInterval(iv);
          hide('processing');
          show('landing');
          $('errorBanner').textContent=err.message;
          show('errorBanner');
        }
      };
      reader.readAsText(file);
    };
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "moonshotai/kimi-k2-instruct";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>