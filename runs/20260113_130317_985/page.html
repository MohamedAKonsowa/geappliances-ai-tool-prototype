<think>
Okay, let's tackle this. The user wants an app that analyzes a CSV file of employee times and determines who has the best and worst performance based on their adherence to a 9-5 schedule. Let me break down what needs to be done.

First, I need to parse the CSV data. I'll use Papa Parse since it's allowed. The data includes employee IDs, names, dates, clock-in times, and clock-out times. I'll need to process each row to calculate how much each employee deviates from the 9-5 schedule.

Next, I need to calculate the performance score. The plan is to penalize early arrivals, late arrivals, early departures, and late departures. For each entry, if the clock-in is before 9 AM, that's an early arrival. If it's after 9 AM, that's a late arrival. Similarly for clock-out times. Each minute of deviation adds to their score, with higher penalties for more severe deviations. The employee with the lowest total score is the best performer, and the highest is the worst.

I need to group the data by employee. Using Lodash's groupBy function would help here. Then, for each employee's entries, calculate the total deviation. For each day, compute the time differences and accumulate the total.

Then, I'll need to display this data. The UI should include a file upload, a table showing each employee's metrics, a bar chart for visual comparison, and cards highlighting the best and worst performers. Tailwind CSS and DaisyUI can be used for styling, and Chart.js for the bar chart.

Lucide Icons will be used for the upload and theme toggle icons. The theme toggle should save the user's preference in localStorage. The interactions like drag-and-drop upload and filtering by date range need to be implemented. However, since the user mentioned the two_week_timesheet.csv as attached data, I'll hardcode it into the script for testing.

I'll also include an accordion to explain the methodology. The explanation should clarify how each minute of deviation is calculated and how penalties are applied.

I need to make sure the app is responsive and uses modern JavaScript. Error handling for invalid CSVs and data validation are important. For example, checking that the required columns exist and that times are in the correct format.

Testing each part is crucial. Parsing the CSV, calculating scores correctly, updating the UI dynamically when a new file is uploaded, and ensuring the chart and table reflect the data accurately.

Putting it all together: the HTML structure will include a file input, a chart container, a table, and cards for best/worst. The JavaScript will handle parsing, calculations, and DOM manipulation. Styling with Tailwind ensures a clean, responsive design.

I should also consider edge cases, like employees with no deviations (perfect attendance) or those with multiple days of irregularities. The scoring system needs to aggregate these over all days.

Finally, validate that the app meets all the acceptance criteria: correct parsing, accurate scoring, clear explanations, visual representations, theme toggle, and data validation.
</think>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data: https: blob:; style-src 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; font-src https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://d3js.org https://cdn.plot.ly https://cdn.tailwindcss.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.tile.openstreetmap.org; base-uri 'none'; form-action 'none';">
  <meta charset="UTF-8">
  <title>Employee Performance Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss-jit-cdn"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .employee-card { @apply bg-base-100 shadow-xl rounded-lg p-4 mb-4 transition-transform hover:scale-105; }
    .performance-chart { @apply w-full max-w-4xl mx-auto; }
  </style>
</head>
<body class="bg-base-200 text-base-content min-h-screen flex flex-col">
  <div class="navbar bg-base-100">
    <div class="flex-1">
      <a class="btn btn-ghost text-xl">Employee Performance Analyzer</a>
    </div>
    <div class="flex-none">
      <button id="theme-toggle" class="btn btn-square btn-ghost">
        <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 12.728l-.707-.707M2 12C2 6.477 6.477 2 12 2s10 4.475 10 10-4.475 10-10 10z" />
        </svg>
      </button>
    </div>
  </div>

  <main class="container mx-auto p-4 flex-1">
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <div class="flex justify-center items-center">
          <label class="btn btn-primary btn-lg flex items-center gap-2">
            <i data-lucide="upload-cloud" class="w-5 h-5"></i>
            Upload CSV File
            <input type="file" class="hidden" id="csv-upload" accept=".csv">
          </label>
        </div>
        <p class="text-sm text-base-content/70 mt-2 text-center">Drag & drop or click to select your employee timesheet</p>
      </div>
    </div>

    <div id="analysis-results" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="employee-card bg-success/10 border border-success">
          <h3 class="text-success font-bold text-lg">Best Performer</h3>
          <div id="best-performer" class="text-center py-4">
            <div class="h-24 flex items-center justify-center">
              <i data-lucide="award" class="w-16 h-16 text-success"></i>
            </div>
            <h4 class="text-xl font-bold text-success">Loading...</h4>
            <p class="text-sm text-base-content/70">Score: N/A</p>
            <p class="text-sm text-base-content/70 mt-2">Deviation: N/A</p>
          </div>
        </div>

        <div class="employee-card bg-error/10 border border-error">
          <h3 class="text-error font-bold text-lg">Worst Performer</h3>
          <div id="worst-performer" class="text-center py-4">
            <div class="h-24 flex items-center justify-center">
              <i data-lucide="alert-triangle" class="w-16 h-16 text-error"></i>
            </div>
            <h4 class="text-xl font-bold text-error">Loading...</h4>
            <p class="text-sm text-base-content/70">Score: N/A</p>
            <p class="text-sm text-base-content/70 mt-2">Deviation: N/A</p>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="text-xl font-bold mb-4">Performance Comparison</h3>
        <canvas id="performance-chart" class="performance-chart"></canvas>
      </div>

      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
          <h3 class="card-title">Employee Performance Table</h3>
          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th class="text-center">Total Deviation</th>
                  <th class="text-center">Score</th>
                </tr>
              </thead>
              <tbody id="performance-table">
                <tr>
                  <td colspan="3" class="text-center py-4">
                    <span class="loading loading-spinner"></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h3 class="card-title">Analysis Methodology</h3>
          <details class="collapse collapse-arrow border-base-300">
            <summary>How We Calculate Performance</summary>
            <div class="p-4">
              <p class="text-sm text-base-content/70">
                We calculate performance based on deviations from the standard 9-5 workday. For each time entry:
                <ul class="list-disc pl-5 mt-2">
                  <li>Early arrivals: 1 point per minute before 09:00</li>
                  <li>Late arrivals: 2 points per minute after 09:00</li>
                  <li>Early departures: 2 points per minute before 17:00</li>
                  <li>Late departures: 1 point per minute after 17:00</li>
                </ul>
                <br/>
                Employees with the lowest total score are considered best performers. This system rewards punctuality while accounting for both arrival and departure times.
              </p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Initialize icons
    lucide.createIcons();

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const currentTheme = localStorage.getItem('theme');
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeIcon.innerHTML = theme === 'dark' 
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 12.728l-.707-.707M2 12C2 6.477 6.477 2 12 2s10 4.475 10 10-4.475 10-10 10z"/>' 
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
    }

    if (currentTheme) {
      setTheme(currentTheme);
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(prefersDark ? 'dark' : 'light');
    }

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    // Sample data from the provided CSV
    const sampleCSV = `employee_id,name,date,clock_in,clock_out
E001,Alex Rivera,2026-01-05,09:02,17:00
E002,Jordan Lee,2026-01-05,08:58,17:03
E003,Taylor Morgan,2026-01-05,09:06,16:59
E004,Sam Patel,2026-01-05,09:00,17:05
E005,Casey Nguyen,2026-01-05,09:04,17:01
E001,Alex Rivera,2026-01-06,09:00,17:02
E002,Jordan Lee,2026-01-06,09:03,17:00
E003,Taylor Morgan,2026-01-06,08:57,17:06
E004,Sam Patel,2026-01-06,09:08,17:01
E005,Casey Nguyen,2026-01-06,09:01,17:04
E001,Alex Rivera,2026-01-07,08:59,17:01
E002,Jordan Lee,2026-01-07,09:05,17:02
E003,Taylor Morgan,2026-01-07,09:00,17:00
E004,Sam Patel,2026-01-07,08:56,17:03
E005,Casey Nguyen,2026-01-07,09:07,17:00
E001,Alex Rivera,2026-01-08,09:04,17:00
E002,Jordan Lee,2026-01-08,09:00,17:04
E003,Taylor Morgan,2026-01-08,09:02,17:01
E004,Sam Patel,2026-01-08,09:06,17:02
E005,Casey Nguyen,2026-01-08,08:59,17:05
E001,Alex Rivera,2026-01-09,09:01,16:58
E002,Jordan Lee,2026-01-09,08:55,17:00
E003,Taylor Morgan,2026-01-09,09:03,17:04
E004,Sam Patel,2026-01-09,09:00,17:01
E005,Casey Nguyen,2026-01-09,09:05,17:02
E001,Alex Rivera,2026-01-12,09:00,17:03
E002,Jordan Lee,2026-01-12,09:02,17:01
E003,Taylor Morgan,2026-01-12,08:58,17:00
E004,Sam Patel,2026-01-12,09:07,17:02
E005,Casey Nguyen,2026-01-12,09:01,17:05
E001,Alex Rivera,2026-01-13,09:03,17:00
E002,Jordan Lee,2026-01-13,09:00,17:06
E003,Taylor Morgan,2026-01-13,09:04,17:02
E004,Sam Patel,2026-01-13,08:57,17:01
E005,Casey Nguyen,2026-01-13,09:06,16:59
E001,Alex Rivera,2026-01-14,08:57,17:02
E002,Jordan Lee,2026-01-14,09:06,17:00
E003,Taylor Morgan,2026-01-14,09:00,17:05
E004,Sam Patel,2026-01-14,09:02,17:01
E005,Casey Nguyen,2026-01-14,08:59,17:03
E001,Alex Rivera,2026-01-15,09:05,17:01
E002,Jordan Lee,2026-01-15,08:59,17:02
E003,Taylor Morgan,2026-01-15,09:02,17:00
E004,Sam Patel,2026-01-15,09:00,17:04
E005,Casey Nguyen,2026-01-15,09:03,17:01
E001,Alex Rivera,2026-01-16,09:00,17:00
E002,Jordan Lee,2026-01-16,09:04,16:58
E003,Taylor Morgan,2026-01-16,08:56,17:02
E004,Sam Patel,2026-01-16,09:01,17:00
E005,Casey Nguyen,2026-01-16,09:02,17:03`;

    // Initialize with sample data
    let csvData = null;
    let chart = null;

    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function calculatePerformanceData(data) {
      const employeeData = {};
      
      // Group by employee
      _.forEach(data, (row) => {
        const { employee_id, name } = row;
        if (!employeeData[employee_id]) {
          employeeData[employee_id] = {
            name,
            totalDeviation: 0,
            entries: []
          };
        }
        
        const clockIn = parseTime(row.clock_in);
        const clockOut = parseTime(row.clock_out);
        
        // Calculate deviation points
        let deviationScore = 0;
        
        // Early arrivals (before 9:00)
        if (clockIn < 9 * 60) {
          deviationScore += (9 * 60 - clockIn) * 1;
        }
        // Late arrivals (after 9:00)
        if (clockIn > 9 * 60) {
          deviationScore += (clockIn - 9 * 60) * 2;
        }
        
        // Early departures (before 17:00)
        if (clockOut < 17 * 60) {
          deviationScore += (17 * 60 - clockOut) * 2;
        }
        // Late departures (after 17:00)
        if (clockOut > 17 * 60) {
          deviationScore += (clockOut - 17 * 60) * 1;
        }
        
        employeeData[employee_id].totalDeviation += deviationScore;
        employeeData[employee_id].entries.push({
          date: row.date,
          clockIn: row.clock_in,
          clockOut: row.clock_out,
          deviation: deviationScore
        });
      });
      
      // Convert to array and sort
      const sortedEmployees = _.sortBy(
        _.values(employeeData),
        'totalDeviation'
      );
      
      return {
        employees: sortedEmployees,
        best: sortedEmployees[0],
        worst: sortedEmployees[sortedEmployees.length - 1]
      };
    }

    function updateUI(data) {
      // Show results container
      document.getElementById('analysis-results').classList.remove('hidden');
      
      // Update best performer card
      const best = data.best;
      const bestCard = document.getElementById('best-performer');
      bestCard.innerHTML = `
        <h4 class="text-xl font-bold text-success">${best.name}</h4>
        <p class="text-sm text-base-content/70">Score: ${best.totalDeviation}</p>
        <p class="text-sm text-base-content/70 mt-2">Deviation: ${formatDeviation(best.totalDeviation)}</p>
      `;
      
      // Update worst performer card
      const worst = data.worst;
      const worstCard = document.getElementById('worst-performer');
      worstCard.innerHTML = `
        <h4 class="text-xl font-bold text-error">${worst.name}</h4>
        <p class="text-sm text-base-content/70">Score: ${worst.totalDeviation}</p>
        <p class="text-sm text-base-content/70 mt-2">Deviation: ${formatDeviation(worst.totalDeviation)}</p>
      `;

      // Update performance chart
      if (chart) {
        chart.destroy();
      }

      const ctx = document.getElementById('performance-chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.employees.map(emp => emp.name),
          datasets: [{
            label: 'Total Deviation Score',
            data: data.employees.map(emp => emp.totalDeviation),
            backgroundColor: data.employees.map(emp => 
              emp.totalDeviation === best.totalDeviation ? '#28c840' :
              emp.totalDeviation === worst.totalDeviation ? '#ff5f57' :
              '#007a8a'
            ),
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.parsed.y;
                  return `Score: ${value} (${formatDeviation(value)})`;
                }
              }
            },
            title: {
              display: true,
              text: 'Employee Performance Comparison'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Total Deviation Score'
              }
            }
          }
        }
      });

      // Update performance table
      const tableBody = document.getElementById('performance-table');
      tableBody.innerHTML = '';
      
      data.employees.forEach((emp, index) => {
        const row = document.createElement('tr');
        row.className = index === 0 ? 'bg-success/10' : index === data.employees.length - 1 ? 'bg-error/10' : '';
        
        row.innerHTML = `
          <td>
            <div class="flex items-center gap-2">
              <span class="font-bold">#${index + 1}</span>
              <div>
                <div class="font-bold">${emp.name}</div>
                <div class="text-sm opacity-70">${emp.employee_id}</div>
              </div>
            </div>
          </td>
          <td class="text-center">${formatDeviation(emp.totalDeviation)}</td>
          <td class="text-center">${emp.totalDeviation}</td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    function formatDeviation(score) {
      const minutes = Math.round(score / 3);
      return `${minutes} minutes of deviation`;
    }

    // Initialize with sample data
    Papa.parse(sampleCSV, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        if (results.errors.length) {
          console.error('CSV parsing errors:', results.errors);
          return;
        }
        
        csvData = results.data;
        const analysis = calculatePerformanceData(csvData);
        updateUI(analysis);
      }
    });

    // File upload handler
    document.getElementById('csv-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          if (results.errors.length) {
            alert('Error parsing CSV file. Please check the file format.');
            return;
          }
          
          csvData = results.data;
          const analysis = calculatePerformanceData(csvData);
          updateUI(analysis);
        }
      });
    });
  </script>

<script id="gea-runtime-helper">
(function () {
  if (window.geaRuntimeLLM) return;
  const defaultModel = "qwen/qwen3-32b";
  async function callRuntimeLLM(prompt, options = {}) {
    if (!prompt || typeof prompt !== "string") {
      throw new Error("Prompt must be a non-empty string");
    }
    const model = typeof options.model === 'string' && options.model.trim() ? options.model.trim() : defaultModel;
    const response = await fetch('/api/runtime/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, model }),
      signal: options.signal
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error && error.error ? error.error : 'Runtime LLM request failed');
    }
    const data = await response.json().catch(() => ({}));
    return data && data.response ? data.response : '';
  }
  window.geaRuntimeLLM = callRuntimeLLM;
})();
</script>
</body>
</html>